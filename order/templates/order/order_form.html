{% extends 'base.html' %}

{% block content %}

<h1 class="text-center mb-4">{{ form_title }}</h1>

{% if form.errors %}
<div class="alert alert-danger">
    <h4>Please correct the following errors:</h4>
    <ul>
    {% for field, errors in form.errors.items %}
        <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<div class="card shadow">
    <div class="card-body">

        <form method="post" novalidate id="order-form">
            {% csrf_token %}
            {{ form.amount }}
            {{ form.subtotal }}
            {{ form.discount }}
            {{ form.tax }}
            {{ form.total }}
            {{ form.order_lines_json }}

            <!-- Order / Customer / Status compact header fields -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-light border-0">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end small">
                                {% if not is_sale_create %}
                                <!-- Order Date -->
                                <div class="col-md-3 col-sm-4">
                                    <label class="form-label mb-1" for="id_order_date">{{ form.order_date.label }}</label>
                                    <input
                                        type="text"
                                        id="id_order_date"
                                        name="order_date"
                                        class="form-control form-control-sm"
                                        placeholder="Order Date (BS)"
                                        value="{{ form.order_date.value|default:'' }}"
                                    />
                                </div>
                                <!-- Deliver Date -->
                                <div class="col-md-3 col-sm-4">
                                    <label class="form-label mb-1" for="id_deliver_date">{{ form.deliver_date.label }}</label>
                                    <input
                                        type="text"
                                        id="id_deliver_date"
                                        name="deliver_date"
                                        class="form-control form-control-sm"
                                        placeholder="Deliver Date (BS)"
                                        value="{{ form.deliver_date.value|default:'' }}"
                                    />
                                </div>
                                {% endif %}

                                <!-- Customer Name -->
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label mb-1" for="id_customer_name">{{ form.customer_name.label }}</label>
                                    <input
                                        type="text"
                                        id="id_customer_name"
                                        name="customer_name"
                                        class="form-control form-control-sm"
                                        placeholder="Customer name"
                                        value="{{ form.customer_name.value|default:'' }}"
                                    />
                                    {% if form.customer_name.errors %}
                                        <div class="text-danger small">{{ form.customer_name.errors }}</div>
                                    {% endif %}
                                </div>

                                <!-- Phone Number -->
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label mb-1" for="id_phone_number">{{ form.phone_number.label }}</label>
                                    <input
                                        type="text"
                                        id="id_phone_number"
                                        name="phone_number"
                                        class="form-control form-control-sm"
                                        placeholder="Phone (7-15 digits)"
                                        value="{{ form.phone_number.value|default:'' }}"
                                    />
                                    {% if form.phone_number.errors %}
                                        <div class="text-danger small">{{ form.phone_number.errors }}</div>
                                    {% endif %}
                                </div>

                                {% if is_sale_create %}
                                <!-- Bill No (Sales create only) -->
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label mb-1" for="id_bill_no">Bill No</label>
                                    <input
                                        type="text"
                                        id="id_bill_no"
                                        name="bill_no"
                                        class="form-control form-control-sm"
                                        placeholder="Bill number"
                                        value="{{ bill_no|default:'' }}"
                                    />
                                </div>
                                <!-- Sale Date (Sales create only) -->
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label mb-1" for="id_sale_date">Sale Date (BS)</label>
                                    <input
                                        type="text"
                                        id="id_sale_date"
                                        name="sale_date"
                                        class="form-control form-control-sm"
                                        placeholder="Sale Date (BS)"
                                        value="{{ sale_date|default:'' }}"
                                    />
                                </div>
                                {% endif %}

                                {# Status is always 'Order' by default; hidden from UI #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4" />
            <h5 class="mb-3">Select Existing Ornaments from Inventory</h5>

            <div class="mb-3">
                <label class="form-label">Search & Select Ornaments</label>
                <input type="text" id="ornament-search" class="form-control" placeholder="Search by name, code, metal type...">
                <div id="search-results" style="border: 1px solid #ddd; margin-top: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; display: none;">
                    <div id="results-list" style="padding: 10px;"></div>
                </div>
            </div>

            <!-- Selected Ornaments Details Table with Rate Inputs -->
            <div class="mb-3">
                <h6 class="mb-2">Selected Ornaments Details & Rates:</h6>
                
                <div style="overflow-x: auto;">
                    <table class="table table-bordered table-sm" id="selected-ornaments-table">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2">Code</th>
                                <th colspan="2" class="text-center">Gold</th>
                                <th colspan="2" class="text-center">Diamond</th>
                                <th colspan="2" class="text-center">Zircon</th>
                                <th colspan="2" class="text-center">Stone</th>
                                <th rowspan="2">Jarti</th>
                                <th rowspan="2">Jyala</th>
                                <th rowspan="2">Amount</th>
                                <th rowspan="2">Action</th>
                            </tr>
                            <tr>
                                <th>Weight</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody id="selected-ornaments-body">
                        </tbody>
                    </table>
                </div>

                <!-- Financial Summary + Payment (compact) -->
                <div class="row mt-4 g-3">
                    <!-- Financial Summary Section -->
                    <div class="col-md-7 col-lg-8">
                        <div class="card bg-light small">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">Financial Summary</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Amount</label>
                                        <input type="number" id="order-subtotal" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #f0f0f0;">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Discount</label>
                                        <input type="number" id="order-discount" class="form-control form-control-sm" step="0.01" value="0" placeholder="Discount">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Subtotal (after discount)</label>
                                        <input type="number" id="order-discounted-amount" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #f0f0f0;">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Tax (2%)</label>
                                        <input type="number" id="order-tax" class="form-control form-control-sm" step="0.01" value="0.00" placeholder="Auto or custom">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold mb-1">Total</label>
                                        <input type="number" id="order-total" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #e8f5e9; font-weight: bold; border: 2px solid #4caf50;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="col-md-5 col-lg-4">
                        <div class="card mb-3 small">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">Payment</h6>
                                <div class="mb-2">
                                    <label class="form-label fw-bold mb-1" for="id_payment_mode">Payment Mode</label>
                                    <select id="id_payment_mode" name="payment_mode" class="form-select form-select-sm">
                                        {% for key, value in form.payment_mode.field.choices %}
                                            <option value="{{ key }}" {% if form.payment_mode.value == key %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-bold mb-1" for="id_payment_amount">Payment Amount</label>
                                    <input type="number" id="id_payment_amount" name="payment_amount" class="form-control form-control-sm" step="0.01" value="{{ form.payment_amount.value|default:'0.00' }}">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-bold mb-1">Remaining Amount</label>
                                    <input type="number" id="payment-remaining" class="form-control form-control-sm" step="0.01" value="0.00" readonly style="background-color: #f0f0f0;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit buttons -->
            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-success">
                    {% if is_sale_create %}Save Sale{% else %}Save Order{% endif %}
                </button>
                {% if is_sale_create %}
                    <a href="{% url 'sales:sales_list' %}" class="btn btn-secondary">Cancel</a>
                {% else %}
                    <a href="{% url 'order:list' %}" class="btn btn-secondary">Cancel</a>
                {% endif %}
            </div>
        </form>

    </div>
</div>

<!-- Custom Jarti Modal -->
<div class="modal fade" id="jartiCustomModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Custom Jarti Percentage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Enter Jarti Percentage</label>
                <input type="number" id="jarti-custom-percentage" class="form-control" step="0.01" min="0" max="100" placeholder="e.g., 8">
                <small class="text-muted d-block mt-2">Jarti will be calculated as: % × Average Ornament Weight</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomJarti()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- BOOTSTRAP JS (only once) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your JS logic -->
<script>
let selectedOrnaments = {};

// Search ornaments
document.getElementById('ornament-search').addEventListener('input', function() {
    const query = this.value.trim();
    const resultsDiv = document.getElementById('search-results');
    const resultsList = document.getElementById('results-list');
    
    if (query.length < 1) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    const searchUrl = `{% url 'order:search_ornaments' %}?q=${encodeURIComponent(query)}`;
    console.log('Fetching from:', searchUrl);
    
    fetch(searchUrl)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            resultsList.innerHTML = '';
            if (data.ornaments.length === 0) {
                resultsList.innerHTML = '<div class="p-2 text-muted">No ornaments found</div>';
            } else {
                data.ornaments.forEach(ornament => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border-bottom cursor-pointer';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <strong>${ornament.code}</strong> - ${ornament.name} 
                        <small class="text-muted">(${ornament.metal_type})</small>
                    `;
                    div.onclick = () => selectOrnament(ornament);
                    resultsList.appendChild(div);
                });
            }
            resultsDiv.style.display = 'block';
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultsList.innerHTML = `<div class="p-2 text-danger">Error: ${error.message}</div>`;
            resultsDiv.style.display = 'block';
        });
});

function selectOrnament(ornament) {
    if (selectedOrnaments[ornament.id]) {
        alert('This ornament is already selected');
        return;
    }
    
    selectedOrnaments[ornament.id] = ornament;
    addOrnamentToTable(ornament);
    updateHiddenField();
    document.getElementById('ornament-search').value = '';
    document.getElementById('search-results').style.display = 'none';
}

function addOrnamentToTable(ornament) {
    const tbody = document.getElementById('selected-ornaments-body');
    const row = document.createElement('tr');
    row.id = `ornament-row-${ornament.id}`;

    const goldRateVal = ornament.gold_rate ?? '';
    const diamondRateVal = ornament.diamond_rate ?? '';
    const zirconRateVal = ornament.zircon_rate ?? '';
    const stoneRateVal = ornament.stone_rate ?? '';
    const jartiVal = ornament.jarti ?? '';
    const jyalaVal = ornament.jyala ?? '';
    const lineAmountVal = (() => {
        const v = ornament.line_amount ?? 0;
        const num = parseFloat(v) || 0;
        return num.toFixed(2);
    })();

    row.innerHTML = `
        <td>${ornament.code}</td>
        <td>${ornament.weight.toFixed(2)}</td>
        <td><input type="number" class="form-control form-control-sm gold-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${goldRateVal}"></td>
        <td>${ornament.diamond_weight.toFixed(2)}</td>
        <td><input type="number" class="form-control form-control-sm diamond-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${diamondRateVal}"></td>
        <td>${(ornament.zircon_weight || 0).toFixed(2)}</td>
        <td><input type="number" class="form-control form-control-sm zircon-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${zirconRateVal}"></td>
        <td>${ornament.stone_weight.toFixed(2)}</td>
        <td><input type="number" class="form-control form-control-sm stone-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${stoneRateVal}"></td>
        <td>
            <div class="d-flex gap-1 align-items-center">
                <input type="number" class="form-control form-control-sm jarti-input" step="0.001" data-id="${ornament.id}" placeholder="Jarti" value="${jartiVal}">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary jarti-percentage-row" data-id="${ornament.id}" data-percentage="8">8%</button>
                    <button type="button" class="btn btn-outline-secondary jarti-percentage-row" data-id="${ornament.id}" data-percentage="10">10%</button>
                    <button type="button" class="btn btn-outline-secondary jarti-percentage-row" data-id="${ornament.id}" data-percentage="12">12%</button>
                    <button type="button" class="btn btn-outline-secondary jarti-percentage-row" data-id="${ornament.id}" data-percentage="15">15%</button>
                </div>
            </div>
        </td>
        <td>
            <div class="d-flex gap-1 align-items-center">
                <input type="number" class="form-control form-control-sm jyala-input" step="0.01" data-id="${ornament.id}" placeholder="Jyala" value="${jyalaVal}">
                <button type="button" class="btn btn-outline-secondary btn-sm jyala-auto-btn" data-id="${ornament.id}" title="Auto: weight × 2000">Auto</button>
            </div>
        </td>
        <td><input type="number" class="form-control form-control-sm subtotal-display" readonly style="background-color: #f0f0f0; border: 1px solid #ccc;" data-id="${ornament.id}" value="${lineAmountVal}"></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeOrnament(${ornament.id})">Remove</button></td>
    `;
    tbody.appendChild(row);
    
    // Attach calculation listeners
    attachOrnamentCalculationListeners(ornament.id, ornament);
}

function initExistingOrnaments() {
    // On edit, pre-populate the selected ornaments table from OrderOrnament lines
    {% if form.instance.pk %}
    const initialOrnaments = [
        {% for line in form.instance.order_ornaments.all %}
        {
            id: {{ line.ornament.id }},
            code: "{{ line.ornament.code|default:'N/A'|escapejs }}",
            name: "{{ line.ornament.ornament_name|escapejs }}",
            metal_type: "{{ line.ornament.metal_type|escapejs }}",
            weight: {{ line.ornament.weight|default:'0' }},
            jarti: {{ line.jarti|default:'0' }},
            jyala: {{ line.jyala|default:'0' }},
            gross_weight: {{ line.ornament.gross_weight|default:'0' }},
            stone_weight: {{ line.ornament.stone_weight|default:'0' }},
            diamond_weight: {{ line.ornament.diamond_weight|default:'0' }},
            zircon_weight: {{ line.ornament.zircon_weight|default:'0' }},
            gold_rate: {{ line.gold_rate|default:'0' }},
            diamond_rate: {{ line.diamond_rate|default:'0' }},
            zircon_rate: {{ line.zircon_rate|default:'0' }},
            stone_rate: {{ line.stone_rate|default:'0' }},
            line_amount: {{ line.line_amount|default:'0' }},
        },
        {% endfor %}
    ];

    initialOrnaments.forEach(ornament => {
        selectedOrnaments[ornament.id] = ornament;
        addOrnamentToTable(ornament);
    });

    // Ensure hidden existing_ornaments field reflects current selection
    updateHiddenField();
    {% endif %}
}

function attachOrnamentCalculationListeners(ornamentId, ornament) {
    const goldRateInput = document.querySelector(`.gold-rate-input[data-id="${ornamentId}"]`);
    const diamondRateInput = document.querySelector(`.diamond-rate-input[data-id="${ornamentId}"]`);
    const zirconRateInput = document.querySelector(`.zircon-rate-input[data-id="${ornamentId}"]`);
    const stoneRateInput = document.querySelector(`.stone-rate-input[data-id="${ornamentId}"]`);
    const jartiInput = document.querySelector(`.jarti-input[data-id="${ornamentId}"]`);
    const jyalaInput = document.querySelector(`.jyala-input[data-id="${ornamentId}"]`);
    const discountInput = document.getElementById('order-discount');
    const subtotalDisplay = document.querySelector(`.subtotal-display[data-id="${ornamentId}"]`);
    
    const calculateSubtotal = () => {
        // Get rates from individual inputs
        const goldRate = parseFloat(goldRateInput?.value) || 0;
        const diamondRate = parseFloat(diamondRateInput?.value) || 0;
        const zirconRate = parseFloat(zirconRateInput?.value) || 0;
        const stoneRate = parseFloat(stoneRateInput?.value) || 0;
        const jarti = parseFloat(jartiInput?.value) || 0;
        const jyala = parseFloat(jyalaInput?.value) || 0;
        
        // Formula: subtotal = ((weight + jarti) / 11.664 * goldRate) + (diamondWeight * diamondRate) + (zirconWeight * zirconRate) + (stoneWeight * stoneRate) + jyala
        // Do NOT include discount here - discount is applied at order level only
        const goldComponent = ((ornament.weight + jarti) / 11.664) * goldRate;
        const diamondComponent = ornament.diamond_weight * diamondRate;
        const zirconComponent = (ornament.zircon_weight || 0) * zirconRate;
        const stoneComponent = ornament.stone_weight * stoneRate;
        
        const subtotal = goldComponent + diamondComponent + zirconComponent + stoneComponent + jyala;
        
        if (subtotalDisplay) {
            subtotalDisplay.value = Math.max(0, subtotal).toFixed(2);
        }
        
        // Update order total
        updateOrderTotal();
    };
    
    goldRateInput?.addEventListener('input', calculateSubtotal);
    diamondRateInput?.addEventListener('input', calculateSubtotal);
    zirconRateInput?.addEventListener('input', calculateSubtotal);
    stoneRateInput?.addEventListener('input', calculateSubtotal);
    jartiInput?.addEventListener('input', calculateSubtotal);
    jyalaInput?.addEventListener('input', calculateSubtotal);

    // Per-row Jarti percentage buttons
    document.querySelectorAll(`.jarti-percentage-row[data-id="${ornamentId}"]`).forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const pct = parseFloat(this.getAttribute('data-percentage')) || 0;
            calculateJartiForOrnament(ornamentId, pct);
            // visual feedback
            const group = document.querySelectorAll(`.jarti-percentage-row[data-id="${ornamentId}"]`);
            group.forEach(b => { b.classList.remove('active'); b.style.backgroundColor = ''; b.style.color = ''; });
            this.classList.add('active'); this.style.backgroundColor = '#0d6efd'; this.style.color = 'white';
        });
    });

    // Per-row Jyala auto button
    const jyalaAutoBtn = document.querySelector(`.jyala-auto-btn[data-id="${ornamentId}"]`);
    jyalaAutoBtn?.addEventListener('click', function(e) {
        e.preventDefault();
        calculateJyalaForOrnament(ornamentId);
    });
}

function updateOrderTotal() {
    // Calculate amount from selected ornaments (sum of per-row subtotals)
    let amount = 0;
    document.querySelectorAll('.subtotal-display').forEach(field => {
        amount += parseFloat(field.value) || 0;
    });
    // include any legacy formset subtotal fields as well (if present)
    document.querySelectorAll('.subtotal-field').forEach(field => {
        amount += parseFloat(field.value) || 0;
    });

    // Update visible Amount field (only changes when ornaments change)
    const amountField = document.getElementById('order-subtotal');
    if (amountField) {
        amountField.value = amount.toFixed(2);
    }

    // Sync hidden Django amount field if present
    const hiddenAmountField = document.querySelector('input[name="amount"]');
    if (hiddenAmountField) {
        hiddenAmountField.value = amount.toFixed(2);
    }

    // Update derived fields (subtotal after discount, tax, total)
    updateDerivedFields(amount);
}

function updateDerivedFields(amount) {
    // Get discount value - only this affects Subtotal (after discount)
    const discount = parseFloat(document.getElementById('order-discount')?.value) || 0;
    const discountedAmount = amount - discount;

    // Update discounted amount display (Subtotal after discount)
    const discountedAmountField = document.getElementById('order-discounted-amount');
    if (discountedAmountField) {
        discountedAmountField.value = discountedAmount.toFixed(2);
    }

    const taxField = document.getElementById('order-tax');
    const manualFlag = taxField?.dataset.manual === 'true';
    const manualTaxInput = taxField?.value || '';
    const manualTax = parseFloat(manualTaxInput) || 0;

    // Use manual tax only when user explicitly entered a positive value and flagged manual
    let autoTax = 0;
    if (manualFlag && manualTax > 0) {
        autoTax = manualTax;
    } else {
        // Auto-calculate 2% tax on discounted amount
        autoTax = discountedAmount * 0.02;
        // Reset manual flag because we're auto-calculating
        if (taxField) taxField.dataset.manual = 'false';
    }

    // Always reflect the current tax in the input (covers both manual and auto cases)
    if (taxField) {
        taxField.value = autoTax.toFixed(2);
    }

    // Sync hidden Django subtotal field (amount - discount)
    const hiddenSubtotalField = document.querySelector('input[name="subtotal"]');
    if (hiddenSubtotalField) {
        hiddenSubtotalField.value = discountedAmount.toFixed(2);
    }

    // Calculate final total: (amount - discount) + tax
    const total = discountedAmount + autoTax;

    // Update total display
    const totalField = document.getElementById('order-total');
    if (totalField) {
        totalField.value = Math.max(0, total).toFixed(2);
    }

    // Update remaining amount based on payment_amount
    updateRemainingAmount(total);

    // Also update the hidden form field for total if it exists
    const orderTotalField = document.querySelector('input[name="total"]');
    if (orderTotalField) {
        orderTotalField.value = Math.max(0, total).toFixed(2);
    }
}

function updateRemainingAmount(totalValue) {
    // If there are multiple payment_amount inputs (e.g., duplicated field renders), use the last one
    const paymentInputs = Array.from(document.querySelectorAll('input[name="payment_amount"]'));
    const paymentInput = paymentInputs.length ? paymentInputs[paymentInputs.length - 1] : null;
    const remainingField = document.getElementById('payment-remaining');
    const paymentVal = parseFloat(paymentInput?.value) || 0;
    const remaining = Math.max(0, totalValue - paymentVal);
    if (remainingField) {
        remainingField.value = remaining.toFixed(2);
    }
}

function removeOrnament(ornamentId) {
    delete selectedOrnaments[ornamentId];
    const row = document.getElementById(`ornament-row-${ornamentId}`);
    if (row) row.remove();
    updateHiddenField();
    // Recalculate totals after removing an ornament
    updateOrderTotal();
}

function updateHiddenField() {
    const ids = Object.keys(selectedOrnaments);
    let hiddenField = document.querySelector('select[name="existing_ornaments"]');
    
    // Create hidden field if it doesn't exist
    if (!hiddenField) {
        hiddenField = document.createElement('select');
        hiddenField.name = 'existing_ornaments';
        hiddenField.multiple = true;
        hiddenField.style.display = 'none';
        document.querySelector('form').appendChild(hiddenField);
    }
    
    hiddenField.innerHTML = '';
    ids.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.selected = true;
        option.textContent = selectedOrnaments[id].code;
        hiddenField.appendChild(option);
    });
}

function buildOrderLinesPayload() {
    const lines = [];
    Object.keys(selectedOrnaments).forEach(id => {
        const ornament = selectedOrnaments[id];
        const goldRateInput = document.querySelector(`.gold-rate-input[data-id="${id}"]`);
        const diamondRateInput = document.querySelector(`.diamond-rate-input[data-id="${id}"]`);
        const zirconRateInput = document.querySelector(`.zircon-rate-input[data-id="${id}"]`);
        const stoneRateInput = document.querySelector(`.stone-rate-input[data-id="${id}"]`);
        const jartiInput = document.querySelector(`.jarti-input[data-id="${id}"]`);
        const jyalaInput = document.querySelector(`.jyala-input[data-id="${id}"]`);
        const subtotalDisplay = document.querySelector(`.subtotal-display[data-id="${id}"]`);

        const line = {
            ornament_id: parseInt(id),
            gold_rate: parseFloat(goldRateInput?.value) || 0,
            diamond_rate: parseFloat(diamondRateInput?.value) || 0,
            zircon_rate: parseFloat(zirconRateInput?.value) || 0,
            stone_rate: parseFloat(stoneRateInput?.value) || 0,
            jarti: parseFloat(jartiInput?.value) || 0,
            jyala: parseFloat(jyalaInput?.value) || 0,
            line_amount: parseFloat(subtotalDisplay?.value) || 0,
        };
        lines.push(line);
    });

    const hiddenJsonField = document.querySelector('input[name="order_lines_json"]');
    if (hiddenJsonField) {
        hiddenJsonField.value = JSON.stringify(lines);
    }
}

// Jarti Percentage Functions
function calculateJartiFromPercentage(percentage) {
    const ornamentIds = Object.keys(selectedOrnaments);
    if (ornamentIds.length === 0) {
        alert('Please select ornaments first');
        return;
    }
    // For each selected ornament, set its jarti = percentage * ornament weight
    ornamentIds.forEach(id => {
        const weight = selectedOrnaments[id].weight || 0;
        const jartiValue = (percentage / 100) * weight;
        const jartiInput = document.querySelector(`.jarti-input[data-id="${id}"]`);
        if (jartiInput) jartiInput.value = jartiValue.toFixed(3);
    });

    // Trigger recalculation for all ornaments
    triggerAllOrnamentRecalculation();
}

// Calculate Jarti for a single ornament (percentage applies to that ornament's weight)
function calculateJartiForOrnament(ornamentId, percentage) {
    const ornament = selectedOrnaments[ornamentId];
    if (!ornament) return;
    const weight = ornament.weight || 0;
    const jartiValue = (percentage / 100) * weight;
    const jartiInput = document.querySelector(`.jarti-input[data-id="${ornamentId}"]`);
    if (jartiInput) {
        jartiInput.value = jartiValue.toFixed(3);
        jartiInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// Calculate Jyala for a single ornament (weight * 2000)
function calculateJyalaForOrnament(ornamentId) {
    const ornament = selectedOrnaments[ornamentId];
    if (!ornament) return;
    const weight = ornament.weight || 0;
    const jyalaValue = weight * 2000;
    const jyalaInput = document.querySelector(`.jyala-input[data-id="${ornamentId}"]`);
    if (jyalaInput) {
        jyalaInput.value = jyalaValue.toFixed(2);
        jyalaInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

function applyCustomJarti() {
    const customPercentage = parseFloat(document.getElementById('jarti-custom-percentage').value);
    
    if (isNaN(customPercentage) || customPercentage < 0) {
        alert('Please enter a valid percentage');
        return;
    }
    
    calculateJartiFromPercentage(customPercentage);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('jartiCustomModal'));
    if (modal) {
        modal.hide();
    }
    
    // Clear input for next use
    document.getElementById('jarti-custom-percentage').value = '';
}

function triggerAllOrnamentRecalculation() {
    // Trigger recalculation for all selected ornaments (rates, jarti, jyala)
    document.querySelectorAll('.gold-rate-input, .diamond-rate-input, .zircon-rate-input, .stone-rate-input, .jarti-input, .jyala-input').forEach(input => {
        input.dispatchEvent(new Event('input', { bubbles: true }));
    });
}

// Jyala Auto-Calculate Function
function calculateJyalaAuto() {
    const ornamentIds = Object.keys(selectedOrnaments);
    if (ornamentIds.length === 0) {
        alert('Please select ornaments first');
        return;
    }
    // For each selected ornament set jyala = weight * 2000
    ornamentIds.forEach(id => {
        const weight = selectedOrnaments[id].weight || 0;
        const jyalaValue = weight * 2000;
        const jyalaInput = document.querySelector(`.jyala-input[data-id="${id}"]`);
        if (jyalaInput) jyalaInput.value = jyalaValue.toFixed(2);
    });

    // Trigger recalculation for all ornaments
    triggerAllOrnamentRecalculation();
}

function addRow() {
    const totalForms = document.querySelector("#id_ornament_set-TOTAL_FORMS");
    const newIndex = parseInt(totalForms.value);
    
    const row = `
        <tr class="ornament-formset-row" data-row-index="${newIndex}">
            <td><input type="text" name="ornament_set-${newIndex}-ornament_name" class="form-control"></td>
            <td><select name="ornament_set-${newIndex}-metal_type" class="form-control">
                <option value="">---------</option>
                <option value="Gold">Gold</option>
                <option value="Silver">Silver</option>
            </select></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-weight" class="form-control weight-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-jarti" class="form-control jarti-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-jyala" class="form-control jyala-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-rate" class="form-control rate-input" data-index="${newIndex}"></td>
            <td><input type="text" name="ornament_set-${newIndex}-size" class="form-control"></td>
            <td><input type="text" name="ornament_set-${newIndex}-stone" class="form-control"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-total" class="form-control subtotal-field" data-index="${newIndex}" readonly style="background-color: #f0f0f0;"></td>
            <td><input type="checkbox" name="ornament_set-${newIndex}-DELETE"></td>
        </tr>
    `;

    document.querySelector("#ornament-formset-body").insertAdjacentHTML("beforeend", row);
    totalForms.value = newIndex + 1;
    
    // Attach event listeners for calculation
    attachCalculationListeners(newIndex);
}

function attachCalculationListeners(index) {
    const weightInput = document.querySelector(`input[name="ornament_set-${index}-weight"]`);
    const jartiInput = document.querySelector(`input[name="ornament_set-${index}-jarti"]`);
    const jyalaInput = document.querySelector(`input[name="ornament_set-${index}-jyala"]`);
    const rateInput = document.querySelector(`input[name="ornament_set-${index}-rate"]`);
    const subtotalField = document.querySelector(`input[name="ornament_set-${index}-total"]`);
    
    const calculateSubtotal = () => {
        const weight = parseFloat(weightInput?.value) || 0;
        const jarti = parseFloat(jartiInput?.value) || 0;
        const jyala = parseFloat(jyalaInput?.value) || 0;
        const rate = parseFloat(rateInput?.value) || 0;
        
        // Subtotal = (weight * rate) + jarti + jyala
        const subtotal = (weight * rate) + jarti + jyala;
        
        if (subtotalField) {
            subtotalField.value = subtotal.toFixed(2);
        }
        
        // Update order total
        updateOrderTotal();
    };
    
    weightInput?.addEventListener('input', calculateSubtotal);
    jartiInput?.addEventListener('input', calculateSubtotal);
    jyalaInput?.addEventListener('input', calculateSubtotal);
    rateInput?.addEventListener('input', calculateSubtotal);
}


function initFinancialFromHidden() {
    const hiddenAmount = document.querySelector('input[name="amount"]');
    const hiddenDiscount = document.querySelector('input[name="discount"]');
    const hiddenTax = document.querySelector('input[name="tax"]');
    const hiddenTotal = document.querySelector('input[name="total"]');

    const amountVal = parseFloat(hiddenAmount?.value) || 0;
    const discountVal = parseFloat(hiddenDiscount?.value) || 0;
    const taxVal = parseFloat(hiddenTax?.value) || 0;
    const totalVal = parseFloat(hiddenTotal?.value) || 0;

    // If there is any non-zero financial data, prefer it (edit mode)
    if (amountVal || discountVal || taxVal || totalVal) {
        const amountField = document.getElementById('order-subtotal');
        if (amountField) amountField.value = amountVal.toFixed(2);

        const discountFieldVisible = document.getElementById('order-discount');
        if (discountFieldVisible) discountFieldVisible.value = discountVal.toFixed(2);

        const taxFieldVisible = document.getElementById('order-tax');
        if (taxFieldVisible) {
            taxFieldVisible.value = taxVal.toFixed(2);
            taxFieldVisible.dataset.manual = taxVal > 0 ? 'true' : 'false';
        }

        const totalFieldVisible = document.getElementById('order-total');
        if (totalFieldVisible) totalFieldVisible.value = totalVal.toFixed(2);

        const discountedField = document.getElementById('order-discounted-amount');
        if (discountedField) discountedField.value = (amountVal - discountVal).toFixed(2);

        // Update remaining based on existing payment amount
        const paymentInputs = Array.from(document.querySelectorAll('input[name="payment_amount"]'));
        const paymentInput = paymentInputs.length ? paymentInputs[paymentInputs.length - 1] : null;
        const paymentVal = parseFloat(paymentInput?.value) || 0;
        const baseTotal = totalVal || (amountVal - discountVal + taxVal);
        updateRemainingAmount(baseTotal || 0);
    }
}



// Attach listeners to existing rows on page load
document.addEventListener('DOMContentLoaded', function() {
    // For edit view, load ornaments already attached to this order
    initExistingOrnaments();

    document.querySelectorAll('.ornament-formset-row').forEach(row => {
        const index = row.getAttribute('data-row-index');
        if (index) {
            attachCalculationListeners(index);
        }
    });
    
    // Add event listeners for jarti percentage buttons
    document.querySelectorAll('.jarti-percentage').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const percentage = parseInt(this.getAttribute('data-percentage'));
            calculateJartiFromPercentage(percentage);
            
            // Update button styling
            document.querySelectorAll('.jarti-percentage').forEach(b => {
                b.classList.remove('active');
                b.style.backgroundColor = '';
                b.style.color = '';
            });
            this.classList.add('active');
            this.style.backgroundColor = '#0d6efd';
            this.style.color = 'white';
        });
    });
    
    // Add event listener for jyala auto-calculate button
    document.getElementById('jyala-auto-calc-btn')?.addEventListener('click', function(e) {
        e.preventDefault();
        calculateJyalaAuto();
    });
    
    // Recalculate when discount or tax changes (only update derived fields, not Amount)
    // IMPORTANT: Only call updateDiscountAndTax, NOT updateOrderTotal
    const discountField = document.getElementById('order-discount');
    const taxField = document.getElementById('order-tax');
    
    if (discountField) {
        discountField.addEventListener('input', function() {
            const amount = parseFloat(document.getElementById('order-subtotal')?.value) || 0;
            updateDerivedFields(amount);
        });
    }
    
    if (taxField) {
        // Mark manual when user types a positive value; clear manual when zero/empty
        taxField.addEventListener('input', function() {
            const val = parseFloat(this.value);
            this.dataset.manual = val > 0 ? 'true' : 'false';
            const amount = parseFloat(document.getElementById('order-subtotal')?.value) || 0;
            updateDerivedFields(amount);
        });
    }

    const paymentInputs = Array.from(document.querySelectorAll('input[name="payment_amount"]'));
    paymentInputs.forEach(input => {
        input.addEventListener('input', function() {
            const totalVal = parseFloat(document.getElementById('order-total')?.value) || 0;
            updateRemainingAmount(totalVal);
        });
    });

    // Initial financial values: prefer existing saved data (edit)
    // For new orders, this will just keep zeros until ornaments are added.
    initFinancialFromHidden();

    // Form submit handler to sync all calculated values
    const orderForm = document.getElementById('order-form');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            // Sync calculated values to form fields before submission
            const totalField = document.querySelector('input[name="total"]');
            const orderTotal = document.getElementById('order-total')?.value || '0.00';
            if (totalField) {
                totalField.value = orderTotal;
            }

            // Ensure discount is synced
            const discountField = document.querySelector('input[name="discount"]');
            const orderDiscount = document.getElementById('order-discount')?.value || '0.00';
            if (discountField) {
                discountField.value = orderDiscount;
            }

            // Ensure tax is synced
            const taxField = document.querySelector('input[name="tax"]');
            const orderTax = document.getElementById('order-tax')?.value || '0.00';
            if (taxField) {
                taxField.value = orderTax;
            }

            // Build JSON payload for per-ornament lines
            buildOrderLinesPayload();

            console.log('Form submitted with total:', orderTotal, 'discount:', orderDiscount, 'tax:', orderTax);
        });
    }
});

function deleteRow(btn) {
    btn.closest("tr").remove();
}
</script>

{% endblock %}
