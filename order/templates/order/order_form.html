{% extends 'base.html' %}

{% block content %}

<style>
    .ornament-link {
        color: #0d6efd;
        font-weight: 600;
        text-decoration: none;
    }
    .ornament-link:hover {
        text-decoration: underline;
        color: #0a58ca;
    }
</style>

<h1 class="text-center mb-4">{{ form_title }}</h1>

{% if form.errors %}
<div class="alert alert-danger">
    <h4>Please correct the following errors:</h4>
    <ul>
    {% for field, errors in form.errors.items %}
        <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<div class="card shadow">
    <div class="card-body">

        <form method="post" novalidate id="order-form">
            {% csrf_token %}
            {{ form.amount }}
            {{ form.subtotal }}
            {{ form.discount }}
            {{ form.tax }}
            {{ form.total }}
            {{ form.order_lines_json }}
            {{ form.payment_lines_json }}

            <!-- Order / Customer / Status compact header fields -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card bg-light border-0">
                        <div class="card-body py-2">
                            <!-- Right Section Layout -->
                            <div class="row g-2 small">
                                {% if is_sale_create %}
                                <!-- Row 1: Bill No (left) and Sale Date (right) - Sales create only -->
                                <div class="col-12">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_bill_no">Bill No</label>
                                            <input
                                                type="text"
                                                id="id_bill_no"
                                                name="bill_no"
                                                class="form-control form-control-sm"
                                                placeholder="Bill number"
                                                value="{{ bill_no|default:'' }}"
                                            />
                                        </div>
                                        <div class="col-md-3 ms-auto">
                                            <label class="form-label mb-1" for="id_sale_date">Sale Date (BS)</label>
                                            <input
                                                type="text"
                                                id="id_sale_date"
                                                name="sale_date"
                                                class="form-control form-control-sm"
                                                placeholder="Sale Date (BS)"
                                                value="{{ sale_date|default:'' }}"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Order Date (right) - Sales create only -->
                                <div class="col-12">
                                    <div class="row g-2 justify-content-end">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_order_date">{{ form.order_date.label }}</label>
                                            <input
                                                type="text"
                                                id="id_order_date"
                                                name="order_date"
                                                class="form-control form-control-sm"
                                                placeholder="Order Date (BS)"
                                                value="{{ form.order_date.value|default:'' }}"
                                            />
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Row 1: Order Date only (right) - Orders only -->
                                <div class="col-12">
                                    <div class="row g-2 justify-content-end">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_order_date">{{ form.order_date.label }}</label>
                                            <input
                                                type="text"
                                                id="id_order_date"
                                                name="order_date"
                                                class="form-control form-control-sm"
                                                placeholder="Order Date (BS)"
                                                value="{{ form.order_date.value|default:'' }}"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Deliver Date (right) - Orders only -->
                                <div class="col-12">
                                    <div class="row g-2 justify-content-end">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_deliver_date">{{ form.deliver_date.label }}</label>
                                            <input
                                                type="text"
                                                id="id_deliver_date"
                                                name="deliver_date"
                                                class="form-control form-control-sm"
                                                placeholder="Deliver Date (BS)"
                                                value="{{ form.deliver_date.value|default:'' }}"
                                            />
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Row 3 (or 4 for orders): Customer Name, Address, Phone Number, PAN in same row -->
                                <div class="col-12">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_customer_name">{{ form.customer_name.label }}</label>
                                            <input
                                                type="text"
                                                id="id_customer_name"
                                                name="customer_name"
                                                class="form-control form-control-sm"
                                                placeholder="Customer name"
                                                value="{{ form.customer_name.value|default:'' }}"
                                            />
                                            {% if form.customer_name.errors %}
                                                <div class="text-danger small">{{ form.customer_name.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_address">Address</label>
                                            <input
                                                type="text"
                                                id="id_address"
                                                name="address"
                                                class="form-control form-control-sm"
                                                placeholder="Address"
                                                value="{{ form.address.value|default:'' }}"
                                            />
                                            {% if form.address.errors %}
                                                <div class="text-danger small">{{ form.address.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_phone_number">{{ form.phone_number.label }}</label>
                                            <input
                                                type="text"
                                                id="id_phone_number"
                                                name="phone_number"
                                                class="form-control form-control-sm"
                                                placeholder="Phone (7-15 digits)"
                                                value="{{ form.phone_number.value|default:'' }}"
                                            />
                                            {% if form.phone_number.errors %}
                                                <div class="text-danger small">{{ form.phone_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_pan_number">PAN Number</label>
                                            <input
                                                type="text"
                                                id="id_pan_number"
                                                name="pan_number"
                                                class="form-control form-control-sm"
                                                placeholder="PAN number"
                                                value="{{ form.pan_number.value|default:'' }}"
                                            />
                                            {% if form.pan_number.errors %}
                                                <div class="text-danger small">{{ form.pan_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Final Row: Status, Order Type, and Description fields -->
                                <div class="col-12">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_status">{{ form.status.label }}</label>
                                            {{ form.status }}
                                            {% if form.status.errors %}
                                                <div class="text-danger small">{{ form.status.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label mb-1" for="id_order_type">{{ form.order_type.label }}</label>
                                            {{ form.order_type }}
                                            {% if form.order_type.errors %}
                                                <div class="text-danger small">{{ form.order_type.errors }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label mb-1" for="id_description">{{ form.description.label }}</label>
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                                <div class="text-danger small">{{ form.description.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4" />
            <h5 class="mb-3">Add Raw Gold & Silver</h5>

            <!-- Metal Stocks Section -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Raw Metal Details & Rates:</label>
                </div>

                <!-- Metal Formset Management Form -->
                {% if metal_stock_formset %}
                    {{ metal_stock_formset.management_form }}
                {% endif %}
                
                <div style="overflow-x: auto;">
                    <table class="table table-bordered table-sm" id="metal-stocks-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 12%">Stock Type</th>
                                <th style="width: 12%">Metal Type</th>
                                <th style="width: 12%">Purity</th>
                                <th style="width: 12%">Quantity (grams)</th>
                                <th style="width: 12%">Rate Unit</th>
                                <th style="width: 12%">Rate/gram</th>
                                <th style="width: 12%">Remarks</th>
                                <th style="width: 12%">Line Amount</th>
                                <th style="width: 10%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if metal_stock_formset %}
                                {% for form in metal_stock_formset %}
                                    <tr class="metal-stock-row" data-form-index="{{ forloop.counter0 }}">
                                        <!-- Hidden fields for formset (ID, Order) -->
                                        {{ form.id }}
                                        {{ form.order }}
                                        <td>
                                            {% with form.stock_type as field %}
                                                <select name="{{ field.html_name }}" class="form-select form-select-sm stock-type" data-form-index="{{ forloop.counter0 }}">
                                                    <option value="">-- Select Stock Type --</option>
                                                    {% for st in form.fields.stock_type.queryset %}
                                                        <option value="{{ st.pk }}" {% if form.stock_type.value == st.pk|stringformat:'s' %}selected{% endif %}>{{ st }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.stock_type.errors %}<div class="text-danger small">{{ form.stock_type.errors }}</div>{% endif %}
                                                <div class="small text-info mt-1" id="stock-balance-{{ forloop.counter0 }}"></div>
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% with form.metal_type as field %}
                                                <select name="{{ field.html_name }}" class="form-select form-select-sm metal-type" data-form-index="{{ forloop.counter0 }}" {% if form.is_bound %}value="{{ form.metal_type.value }}"{% endif %}>
                                                    <option value="">-- Select Metal --</option>
                                                    <option value="gold" {% if form.metal_type.value == "gold" %}selected{% endif %}>Gold</option>
                                                    <option value="silver" {% if form.metal_type.value == "silver" %}selected{% endif %}>Silver</option>
                                                    <option value="platinum" {% if form.metal_type.value == "platinum" %}selected{% endif %}>Platinum</option>
                                                </select>
                                                {% if form.metal_type.errors %}<div class="text-danger small">{{ form.metal_type.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <script>
                                        // Metal stock balance AJAX fetch
                                        function fetchMetalStockBalance(rowIdx) {
                                            const row = document.querySelector(`tr.metal-stock-row[data-form-index="${rowIdx}"]`);
                                            if (!row) return;
                                            const stockType = row.querySelector('.stock-type')?.value;
                                            const metalType = row.querySelector('.metal-type')?.value;
                                            const purity = row.querySelector('.purity')?.value;
                                            if (!stockType || !metalType || !purity) {
                                                document.getElementById(`stock-balance-${rowIdx}`).textContent = '';
                                                return;
                                            }
                                            fetch(`/order/ajax/metal-stock-balance/?stock_type_id=${stockType}&metal_type=${metalType}&purity=${purity}`)
                                                .then(r => r.json())
                                                .then(data => {
                                                    if (data.balance !== undefined) {
                                                        document.getElementById(`stock-balance-${rowIdx}`).textContent = `Available: ${data.balance}g`;
                                                    } else {
                                                        document.getElementById(`stock-balance-${rowIdx}`).textContent = data.error || 'Error fetching balance';
                                                    }
                                                })
                                                .catch(() => {
                                                    document.getElementById(`stock-balance-${rowIdx}`).textContent = 'Error fetching balance';
                                                });
                                        }
                                        document.addEventListener('DOMContentLoaded', function() {
                                            document.querySelectorAll('.metal-stock-row').forEach(row => {
                                                const idx = row.getAttribute('data-form-index');
                                                row.querySelector('.stock-type')?.addEventListener('change', () => fetchMetalStockBalance(idx));
                                                row.querySelector('.metal-type')?.addEventListener('change', () => fetchMetalStockBalance(idx));
                                                row.querySelector('.purity')?.addEventListener('change', () => fetchMetalStockBalance(idx));
                                                // Initial fetch
                                                fetchMetalStockBalance(idx);
                                            });
                                        });
                                        </script>
                                        <td>
                                            {% with form.purity as field %}
                                                <select name="{{ field.html_name }}" class="form-select form-select-sm purity" {% if form.is_bound %}value="{{ form.purity.value }}"{% endif %}>
                                                    <option value="">-- Select Purity --</option>
                                                    <option value="24K" {% if form.purity.value == "24K" %}selected{% endif %}>24K</option>
                                                    <option value="22K" {% if form.purity.value == "22K" %}selected{% endif %}>22K</option>
                                                    <option value="20K" {% if form.purity.value == "20K" %}selected{% endif %}>20K</option>
                                                    <option value="18K" {% if form.purity.value == "18K" %}selected{% endif %}>18K</option>
                                                    <option value="14K" {% if form.purity.value == "14K" %}selected{% endif %}>14K</option>
                                                </select>
                                                {% if form.purity.errors %}<div class="text-danger small">{{ form.purity.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% with form.quantity as field %}
                                                <input type="number" step="0.001" name="{{ field.html_name }}" class="form-control form-control-sm quantity" value="{{ form.quantity.value|default:'' }}" placeholder="0.000">
                                                {% if form.quantity.errors %}<div class="text-danger small">{{ form.quantity.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% with form.rate_unit as field %}
                                                <select name="{{ field.html_name }}" class="form-select form-select-sm">
                                                    {% for val, label in form.fields.rate_unit.choices %}
                                                        <option value="{{ val }}" {% if form.rate_unit.value == val %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.rate_unit.errors %}<div class="text-danger small">{{ form.rate_unit.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% with form.rate_per_gram as field %}
                                                <input type="number" step="0.01" name="{{ field.html_name }}" class="form-control form-control-sm rate" value="{{ form.rate_per_gram.value|default:'' }}" placeholder="0.00">
                                                {% if form.rate_per_gram.errors %}<div class="text-danger small">{{ form.rate_per_gram.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% with form.remarks as field %}
                                                <input type="text" name="{{ field.html_name }}" class="form-control form-control-sm remarks" value="{{ form.remarks.value|default:'' }}" placeholder="Notes...">
                                                {% if form.remarks.errors %}<div class="text-danger small">{{ form.remarks.errors }}</div>{% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% if form.line_amount %}
                                                <input type="number" step="0.01" name="{{ form.line_amount.html_name }}" class="form-control form-control-sm line-amount" value="{{ form.line_amount.value|default:'0.00' }}" readonly style="background-color: #f0f0f0;">
                                            {% else %}
                                                <input type="number" step="0.01" class="form-control form-control-sm line-amount" value="0.00" readonly style="background-color: #f0f0f0;">
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-metal-row" title="Remove this metal">×</button>
                                            {% with form.DELETE as field %}
                                                <input type="hidden" name="{{ field.html_name }}" class="delete-checkbox" value="">
                                            {% endwith %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-metal-row">+ Add Metal Row</button>
            </div>

            <hr class="my-4" />
            <h5 class="mb-3">Select Existing Ornaments from Inventory</h5>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Search & Select Ornaments</label>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#inlineOrnamentModal">+ Quick Create</button>
                        <a class="btn btn-outline-secondary" href="{% url 'ornament:create' %}" target="_blank" rel="noopener">Full Page</a>
                    </div>
                </div>
                <input type="text" id="ornament-search" class="form-control" placeholder="Search by name, code, metal type...">
                <div id="search-results" style="border: 1px solid #ddd; margin-top: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; display: none;">
                    <div id="results-list" style="padding: 10px;"></div>
                </div>
            </div>

            <!-- Selected Ornaments Details Table with Rate Inputs -->
            <div class="mb-3">
                <h6 class="mb-2">Selected Ornaments Details & Rates:</h6>
                
                <div style="overflow-x: auto;">
                    <table class="table table-bordered table-sm" id="selected-ornaments-table">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2">#</th>
                                <th rowspan="2">Code</th>
                                <th colspan="3" class="text-center">Gold</th>
                                <th rowspan="2">Jyala</th>
                                <th colspan="2" class="text-center">Diamond</th>
                                <th colspan="2" class="text-center">Zircon</th>
                                <th colspan="2" class="text-center">Stone</th>
                                <th rowspan="2">Amount</th>
                                <th rowspan="2">Action</th>
                            </tr>
                            <tr>
                                <th>Weight</th>
                                <th>Jarti</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                                <th>Weight</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody id="selected-ornaments-body">
                        </tbody>
                    </table>
                </div>

                <!-- Financial Summary + Payment (compact) -->
                <div class="row mt-4 g-3">
                    <!-- Financial Summary Section -->
                    <div class="col-md-7 col-lg-8">
                        <div class="card bg-light small">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2">Financial Summary</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Amount</label>
                                        <input type="number" id="order-subtotal" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #f0f0f0;">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Discount</label>
                                        <input type="number" id="order-discount" class="form-control form-control-sm" step="0.01" value="0" placeholder="Discount">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Subtotal (after discount)</label>
                                        <input type="number" id="order-discounted-amount" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #f0f0f0;">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label fw-bold mb-1">Tax (2%)</label>
                                        <input type="number" id="order-tax" class="form-control form-control-sm" step="0.01" value="0.00" placeholder="Auto or custom">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold mb-1">Total</label>
                                        <input type="number" id="order-total" class="form-control form-control-sm" step="0.01" value="0" readonly style="background-color: #e8f5e9; font-weight: bold; border: 2px solid #4caf50;">
                                    </div>
                                    <div class="col-12">
                                        <hr class="my-2">
                                        <label class="form-label fw-bold mb-1">Total Metal Weight (grams)</label>
                                        <input type="number" id="total-metal-weight" class="form-control form-control-sm" step="0.001" value="0.000" readonly style="background-color: #f0f0f0;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="col-md-5 col-lg-4">
                        <div class="card mb-3 small">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title mb-0">Payments</h6>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-payment-row">Add Payment</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-2">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 50%">Mode</th>
                                                <th style="width: 35%">Amount</th>
                                                <th style="width: 15%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payment-rows-body"></tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="small text-muted">Paid Total</div>
                                    <div class="fw-bold" id="payment-total-display">0.00</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small text-muted">Remaining Amount</div>
                                    <div class="fw-bold" id="payment-remaining-display">0.00</div>
                                </div>
                                <small class="text-muted d-block mt-2">Multiple payment modes are supported (e.g., part cash, part gold). Totals sync automatically.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit buttons -->
            <div class="mt-4 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-success">
                    {% if is_sale_create %}Save Sale{% else %}Save Order{% endif %}
                </button>
                {% if is_sale_create %}
                    <a href="{% url 'sales:sales_list' %}" class="btn btn-secondary">Cancel</a>
                {% else %}
                    <a href="{% url 'order:list' %}" class="btn btn-secondary">Cancel</a>
                {% endif %}
            </div>
        </form>

    </div>
</div>

<!-- Custom Jarti Modal -->
<div class="modal fade" id="jartiCustomModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Custom Jarti Percentage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Enter Jarti Percentage</label>
                <input type="number" id="jarti-custom-percentage" class="form-control" step="0.01" min="0" max="100" placeholder="e.g., 8">
                <small class="text-muted d-block mt-2">Jarti will be calculated as: % × Average Ornament Weight</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomJarti()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Inline Ornament Create Modal -->
<div class="modal fade" id="inlineOrnamentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Create Ornament</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label mb-1">Name</label>
                        <input type="text" id="inline-ornament-name" class="form-control form-control-sm" placeholder="Ornament name">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Code</label>
                        <input type="text" id="inline-ornament-code" class="form-control form-control-sm" placeholder="Optional code">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Metal Type</label>
                        <select id="inline-ornament-metal" class="form-select form-select-sm">
                            <option value="Gold">Gold</option>
                            <option value="Silver">Silver</option>
                            <option value="Diamond">Diamond</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Type / Purity</label>
                        <select id="inline-ornament-type" class="form-select form-select-sm">
                            <option value="24KARAT">24 Karat</option>
                            <option value="23KARAT">23 Karat</option>
                            <option value="22KARAT">22 Karat</option>
                            <option value="18KARAT">18 Karat</option>
                            <option value="14KARAT">14 Karat</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Kaligar</label>
                        <select id="inline-ornament-kaligar" class="form-select form-select-sm">
                            <option value="">Select Kaligar</option>
                            {% for kaligar in kaligars %}
                            <option value="{{ kaligar.id }}">{{ kaligar.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Main Category</label>
                        <select id="inline-ornament-maincategory" class="form-select form-select-sm">
                            <option value="">Select Main Category</option>
                            {% for category in main_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Sub Category</label>
                        <select id="inline-ornament-subcategory" class="form-select form-select-sm">
                            <option value="">Select Sub Category</option>
                            {% for category in sub_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Weight</label>
                        <input type="number" step="0.001" id="inline-ornament-weight" class="form-control form-control-sm" placeholder="0.000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Diamond Weight</label>
                        <input type="number" step="0.001" id="inline-ornament-diamond" class="form-control form-control-sm" placeholder="0.000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Zircon Weight</label>
                        <input type="number" step="0.001" id="inline-ornament-zircon" class="form-control form-control-sm" placeholder="0.000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Stone Weight</label>
                        <input type="number" step="0.001" id="inline-ornament-stone" class="form-control form-control-sm" placeholder="0.000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Jarti</label>
                        <input type="number" step="0.001" id="inline-ornament-jarti" class="form-control form-control-sm" placeholder="0.000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Jyala</label>
                        <input type="number" step="0.01" id="inline-ornament-jyala" class="form-control form-control-sm" placeholder="0.00">
                    </div>
                </div>
                <div class="alert alert-danger mt-3 d-none" id="inline-ornament-error"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="inline-ornament-save">Save & Add</button>
            </div>
        </div>
    </div>
</div>

<!-- BOOTSTRAP JS (only once) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your JS logic -->
<script>
let selectedOrnaments = {};
const isSaleCreate = "{{ is_sale_create|default:'False'|yesno:'true,false' }}" === 'true';
const paymentModeOptionsHtml = `{% for key, value in payment_choices %}{% if key != 'mixed' %}<option value="{{ key }}">{{ value }}</option>{% endif %}{% endfor %}`;
const initialPayments = JSON.parse('{{ initial_payments_json|escapejs }}');
const ornamentEditTemplate = "{% url 'ornament:update' 0 %}"; // replace 0 with ID in JS

// Search ornaments
// Debounced ornament search
let ornamentSearchTimer;
document.getElementById('ornament-search').addEventListener('input', function() {
    clearTimeout(ornamentSearchTimer);
    const inputEl = this;
    ornamentSearchTimer = setTimeout(() => {
        const query = inputEl.value.trim();
        const resultsDiv = document.getElementById('search-results');
        const resultsList = document.getElementById('results-list');
        
        if (query.length < 1) {
            resultsDiv.style.display = 'none';
            return;
        }
        
        const params = new URLSearchParams({ q: query });
        const searchUrl = `{% url 'order:search_ornaments' %}?${params.toString()}`;
        
        fetch(searchUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                resultsList.innerHTML = '';
                if (data.ornaments.length === 0) {
                    resultsList.innerHTML = '<div class="p-2 text-muted">No ornaments found</div>';
                } else {
                    data.ornaments.forEach(ornament => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom cursor-pointer';
                        div.style.cursor = 'pointer';
                        const wt = (ornament.weight || 0).toFixed(3);
                        const karat = ornament.type || '';
                        div.innerHTML = `
                            <strong>${ornament.code}</strong>
                            <small class="text-muted"> | ${wt} g | ${karat}</small><br>
                            ${ornament.name} <small class="text-muted">(${ornament.metal_type})</small>
                        `;
                        div.onclick = () => selectOrnament(ornament);
                        resultsList.appendChild(div);
                    });
                }
                resultsDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Fetch error:', error);
                resultsList.innerHTML = `<div class="p-2 text-danger">Error: ${error.message}</div>`;
                resultsDiv.style.display = 'block';
            });
    }, 250);
});

// Inline ornament create
const inlineSaveBtn = document.getElementById('inline-ornament-save');
const inlineError = document.getElementById('inline-ornament-error');

// Close modal safely even if Bootstrap instance is missing
function closeInlineOrnamentModal() {
    const modalEl = document.getElementById('inlineOrnamentModal');
    if (!modalEl) return;
    
    // Get or create Bootstrap modal instance
    const instance = bootstrap.Modal.getInstance(modalEl);
    if (instance) {
        instance.hide();
    }
    
    // Force cleanup after a short delay to ensure modal is fully closed
    setTimeout(() => {
        // Remove modal classes
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.setAttribute('aria-hidden', 'true');
        modalEl.removeAttribute('aria-modal');
        modalEl.removeAttribute('role');
        
        // Remove body classes and styles
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Remove all backdrops
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
    }, 150);
}

function inlineOrnamentPayload() {
    return {
        ornament_name: document.getElementById('inline-ornament-name').value.trim(),
        code: document.getElementById('inline-ornament-code').value.trim(),
        metal_type: document.getElementById('inline-ornament-metal').value,
        type: document.getElementById('inline-ornament-type').value,
        weight: document.getElementById('inline-ornament-weight').value,
        diamond_weight: document.getElementById('inline-ornament-diamond').value,
        zircon_weight: document.getElementById('inline-ornament-zircon').value,
        stone_weight: document.getElementById('inline-ornament-stone').value,
        jarti: document.getElementById('inline-ornament-jarti').value,
        jyala: document.getElementById('inline-ornament-jyala').value,
        kaligar: document.getElementById('inline-ornament-kaligar').value,
        maincategory: document.getElementById('inline-ornament-maincategory').value,
        subcategory: document.getElementById('inline-ornament-subcategory').value,
    };
}

inlineSaveBtn?.addEventListener('click', function() {
    inlineError?.classList.add('d-none');
    const payload = inlineOrnamentPayload();

    if (!payload.ornament_name) {
        inlineError.textContent = 'Ornament name is required.';
        inlineError.classList.remove('d-none');
        return;
    }
    if (!payload.kaligar) {
        inlineError.textContent = 'Kaligar is required.';
        inlineError.classList.remove('d-none');
        return;
    }

    // Disable button and show loading state
    inlineSaveBtn.disabled = true;
    const originalText = inlineSaveBtn.textContent;
    inlineSaveBtn.textContent = 'Creating...';

    const formData = new FormData();
    Object.entries(payload).forEach(([k, v]) => formData.append(k, v));

    fetch('{% url "order:create_ornament_inline" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData,
    })
    .then(res => res.json())
    .then(data => {
        // Re-enable button
        inlineSaveBtn.disabled = false;
        inlineSaveBtn.textContent = originalText;
        
        if (!data.ok) {
            inlineError.textContent = data.error || 'Unable to create ornament.';
            inlineError.classList.remove('d-none');
            return;
        }
        
        // Add to selection immediately
        if (data.ornament) {
            selectOrnament(data.ornament);
        }

        // Clear form
        ['inline-ornament-name','inline-ornament-code','inline-ornament-weight','inline-ornament-diamond','inline-ornament-zircon','inline-ornament-stone','inline-ornament-jarti','inline-ornament-jyala'].forEach(id => {
            const el = document.getElementById(id); if (el) el.value = '';
        });
        
        // Close modal (with cleanup for lingering backdrop)
        closeInlineOrnamentModal();
    })
    .catch(err => {
        // Re-enable button on error
        inlineSaveBtn.disabled = false;
        inlineSaveBtn.textContent = originalText;
        
        inlineError.textContent = err.message || 'An error occurred';
        inlineError.classList.remove('d-none');
    });
});

function selectOrnament(ornament) {
    if (selectedOrnaments[ornament.id]) {
        alert('This ornament is already selected');
        return;
    }
    
    selectedOrnaments[ornament.id] = ornament;
    addOrnamentToTable(ornament);
    updateHiddenField();
    document.getElementById('ornament-search').value = '';
    document.getElementById('search-results').style.display = 'none';
}

function addOrnamentToTable(ornament) {
    const tbody = document.getElementById('selected-ornaments-body');
    const row = document.createElement('tr');
    row.id = `ornament-row-${ornament.id}`;

    const editUrl = ornamentEditTemplate.replace('0', ornament.id);
    const codeDisplay = ornament.code || 'N/A';

    const goldRateVal = ornament.gold_rate ?? '';
    const diamondRateVal = ornament.diamond_rate ?? '';
    const zirconRateVal = ornament.zircon_rate ?? '';
    const stoneRateVal = ornament.stone_rate ?? '';
    const jartiVal = ornament.jarti ?? '';
    const jyalaVal = ornament.jyala ?? '';
    const lineAmountVal = (() => {
        const v = ornament.line_amount ?? 0;
        const num = parseFloat(v) || 0;
        return num.toFixed(2);
    })();

    row.innerHTML = `
        <td class="serial-col"></td>
        <td><a href="${editUrl}" target="_blank" rel="noopener" class="ornament-link">${codeDisplay}</a></td>
        <td>${ornament.weight.toFixed(3)}</td>
        <td>
            <div class="d-flex gap-1 align-items-center">
                <input type="number" class="form-control form-control-sm jarti-input" step="0.001" data-id="${ornament.id}" placeholder="Jarti" value="${jartiVal}" style="min-width: 70px; width: 90px;">
                <select class="form-select form-select-sm jarti-percentage-dropdown" data-id="${ornament.id}" style="width: 80px;">
                    <option value="">% Jarti</option>
                    <option value="8">8%</option>
                    <option value="10">10%</option>
                    <option value="12">12%</option>
                    <option value="15">15%</option>
                </select>
            </div>
        </td>
        <td><input type="number" class="form-control form-control-sm gold-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${goldRateVal}" style="min-width: 80px; width: 100px;"></td>
        <td>
            <div class="d-flex gap-1 align-items-center">
                <input type="number" class="form-control form-control-sm jyala-input" step="0.01" data-id="${ornament.id}" placeholder="Jyala" value="${jyalaVal}" style="min-width: 70px; width: 90px;">
                <button type="button" class="btn btn-outline-secondary btn-sm jyala-auto-btn" data-id="${ornament.id}" title="Auto: weight × 2000">Auto</button>
            </div>
        </td>
        <td>${ornament.diamond_weight.toFixed(3)}</td>
        <td><input type="number" class="form-control form-control-sm diamond-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${diamondRateVal}"></td>
        <td>${(ornament.zircon_weight || 0).toFixed(3)}</td>
        <td><input type="number" class="form-control form-control-sm zircon-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${zirconRateVal}"></td>
        <td>${ornament.stone_weight.toFixed(3)}</td>
        <td><input type="number" class="form-control form-control-sm stone-rate-input" step="0.01" data-id="${ornament.id}" placeholder="Rate" value="${stoneRateVal}"></td>
        <td><input type="number" class="form-control form-control-sm subtotal-display" readonly style="background-color: #f0f0f0; border: 1px solid #ccc; min-width: 120px; width: 140px; font-size: 1.1em; font-weight: 600;" data-id="${ornament.id}" value="${lineAmountVal}"></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeOrnament(${ornament.id})">Remove</button></td>
    `;
    tbody.appendChild(row);
    
    // Attach calculation listeners
    attachOrnamentCalculationListeners(ornament.id, ornament);

    refreshSerialNumbers();
}

function refreshSerialNumbers() {
    const rows = document.querySelectorAll('#selected-ornaments-body tr');
    rows.forEach((row, index) => {
        const serialCell = row.querySelector('.serial-col');
        if (serialCell) serialCell.textContent = index + 1;
    });
}

function initExistingOrnaments() {
    // On edit, pre-populate the selected ornaments table from OrderOrnament lines
    {% if form.instance.pk %}
    const initialOrnaments = [
        {% for line in form.instance.order_ornaments.all %}
        {
            id: {{ line.ornament.id }},
            code: "{{ line.ornament.code|default:'N/A'|escapejs }}",
            name: "{{ line.ornament.ornament_name|escapejs }}",
            metal_type: "{{ line.ornament.metal_type|escapejs }}",
            weight: {{ line.ornament.weight|default:'0' }},
            jarti: {{ line.jarti|default:'0' }},
            jyala: {{ line.jyala|default:'0' }},
            gross_weight: {{ line.ornament.gross_weight|default:'0' }},
            stone_weight: {{ line.ornament.stone_weight|default:'0' }},
            diamond_weight: {{ line.ornament.diamond_weight|default:'0' }},
            zircon_weight: {{ line.ornament.zircon_weight|default:'0' }},
            gold_rate: {{ line.gold_rate|default:'0' }},
            diamond_rate: {{ line.diamond_rate|default:'0' }},
            zircon_rate: {{ line.zircon_rate|default:'0' }},
            stone_rate: {{ line.stone_rate|default:'0' }},
            line_amount: {{ line.line_amount|default:'0' }},
        },
        {% endfor %}
    ];

    initialOrnaments.forEach(ornament => {
        selectedOrnaments[ornament.id] = ornament;
        addOrnamentToTable(ornament);
    });

    // Ensure hidden existing_ornaments field reflects current selection
    updateHiddenField();
    {% endif %}
}

function attachOrnamentCalculationListeners(ornamentId, ornament) {
    const goldRateInput = document.querySelector(`.gold-rate-input[data-id="${ornamentId}"]`);
    const diamondRateInput = document.querySelector(`.diamond-rate-input[data-id="${ornamentId}"]`);
    const zirconRateInput = document.querySelector(`.zircon-rate-input[data-id="${ornamentId}"]`);
    const stoneRateInput = document.querySelector(`.stone-rate-input[data-id="${ornamentId}"]`);
    const jartiInput = document.querySelector(`.jarti-input[data-id="${ornamentId}"]`);
    const jyalaInput = document.querySelector(`.jyala-input[data-id="${ornamentId}"]`);
    const discountInput = document.getElementById('order-discount');
    const subtotalDisplay = document.querySelector(`.subtotal-display[data-id="${ornamentId}"]`);
    
    const calculateSubtotal = () => {
        // Get rates from individual inputs
        const goldRate = parseFloat(goldRateInput?.value) || 0;
        const diamondRate = parseFloat(diamondRateInput?.value) || 0;
        const zirconRate = parseFloat(zirconRateInput?.value) || 0;
        const stoneRate = parseFloat(stoneRateInput?.value) || 0;
        const jarti = parseFloat(jartiInput?.value) || 0;
        const jyala = parseFloat(jyalaInput?.value) || 0;
        
        // Formula: subtotal = ((weight + jarti) / 11.664 * goldRate) + (diamondWeight * diamondRate) + (zirconWeight * zirconRate) + (stoneWeight * stoneRate) + jyala
        // Do NOT include discount here - discount is applied at order level only
        const goldComponent = ((ornament.weight + jarti) / 11.664) * goldRate;
        const diamondComponent = ornament.diamond_weight * diamondRate;
        const zirconComponent = (ornament.zircon_weight || 0) * zirconRate;
        const stoneComponent = ornament.stone_weight * stoneRate;
        
        const subtotal = goldComponent + diamondComponent + zirconComponent + stoneComponent + jyala;
        
        if (subtotalDisplay) {
            subtotalDisplay.value = Math.max(0, subtotal).toFixed(2);
        }
        
        // Update order total
        updateOrderTotal();
    };
    
    goldRateInput?.addEventListener('input', calculateSubtotal);
    diamondRateInput?.addEventListener('input', calculateSubtotal);
    zirconRateInput?.addEventListener('input', calculateSubtotal);
    stoneRateInput?.addEventListener('input', calculateSubtotal);
    jartiInput?.addEventListener('input', calculateSubtotal);
    jyalaInput?.addEventListener('input', calculateSubtotal);

    // Jarti percentage dropdown
    const jartiDropdown = document.querySelector(`.jarti-percentage-dropdown[data-id="${ornamentId}"]`);
    if (jartiDropdown) {
        jartiDropdown.addEventListener('change', function(e) {
            const pct = parseFloat(this.value) || 0;
            if (pct > 0) {
                calculateJartiForOrnament(ornamentId, pct);
            }
        });
    }

    // Per-row Jyala auto button
    const jyalaAutoBtn = document.querySelector(`.jyala-auto-btn[data-id="${ornamentId}"]`);
    jyalaAutoBtn?.addEventListener('click', function(e) {
        e.preventDefault();
        calculateJyalaForOrnament(ornamentId);
    });
}

function updateOrderTotal() {
    // Calculate amount from selected ornaments (sum of per-row subtotals)
    let amount = 0;
    document.querySelectorAll('.subtotal-display').forEach(field => {
        amount += parseFloat(field.value) || 0;
    });
    // include any legacy formset subtotal fields as well (if present)
    document.querySelectorAll('.subtotal-field').forEach(field => {
        amount += parseFloat(field.value) || 0;
    });

    // Include raw metal stock line amounts
    document.querySelectorAll('.metal-stock-row:not([data-deleted]) .line-amount').forEach(field => {
        amount += parseFloat(field.value) || 0;
    });

    // Update visible Amount field (only changes when ornaments/metals change)
    const amountField = document.getElementById('order-subtotal');
    if (amountField) {
        amountField.value = amount.toFixed(2);
    }

    // Sync hidden Django amount field if present
    const hiddenAmountField = document.querySelector('input[name="amount"]');
    if (hiddenAmountField) {
        hiddenAmountField.value = amount.toFixed(2);
    }

    // Update derived fields (subtotal after discount, tax, total)
    updateDerivedFields(amount);
}

function updateDerivedFields(amount) {
    // Get discount value - only this affects Subtotal (after discount)
    const discount = parseFloat(document.getElementById('order-discount')?.value) || 0;
    const discountedAmount = amount - discount;

    // Update discounted amount display (Subtotal after discount)
    const discountedAmountField = document.getElementById('order-discounted-amount');
    if (discountedAmountField) {
        discountedAmountField.value = discountedAmount.toFixed(2);
    }

    const taxField = document.getElementById('order-tax');
    const manualFlag = taxField?.dataset.manual === 'true';
    const manualTaxInput = taxField?.value || '';
    const manualTax = parseFloat(manualTaxInput) || 0;

    // Use manual tax only when user explicitly entered a positive value and flagged manual
    let autoTax = 0;
    if (manualFlag && manualTax > 0) {
        autoTax = manualTax;
    } else {
        // Auto-calculate 2% tax on Gold and Diamond ornaments ONLY + Raw Gold/Silver
        // First, calculate amount for Gold and Diamond ornaments only
        let goldDiamondAmount = 0;
        document.querySelectorAll('.subtotal-display').forEach(field => {
            const ornamentId = parseInt(field.getAttribute('data-id'));
            const ornament = selectedOrnaments[ornamentId];
            if (ornament && (ornament.metal_type === 'Gold' || ornament.metal_type === 'Diamond')) {
                goldDiamondAmount += parseFloat(field.value) || 0;
            }
        });
        // Also include any legacy formset subtotal fields that are for Gold/Diamond
        document.querySelectorAll('.subtotal-field').forEach(field => {
            const ornamentId = parseInt(field.getAttribute('data-ornament-id'));
            if (ornamentId) {
                const ornament = selectedOrnaments[ornamentId];
                if (ornament && (ornament.metal_type === 'Gold' || ornament.metal_type === 'Diamond')) {
                    goldDiamondAmount += parseFloat(field.value) || 0;
                }
            } else {
                // If no ornament ID attribute, include it (legacy behavior)
                goldDiamondAmount += parseFloat(field.value) || 0;
            }
        });
        
        // Include raw metal stock line amounts (exclude silver from tax)
        let metalAmount = 0;
        document.querySelectorAll('.metal-stock-row:not([data-deleted])').forEach(row => {
            const metalType = row.querySelector('.metal-type')?.value;
            if (metalType && metalType.toLowerCase() === 'silver') {
                return;
            }
            const lineAmountField = row.querySelector('.line-amount');
            metalAmount += parseFloat(lineAmountField?.value) || 0;
        });
        
        // Total amount taxable = Gold/Diamond ornaments + Raw Metals
        const taxableAmount = goldDiamondAmount + metalAmount;
        
        // Apply discount proportionally to taxable amount
        const taxablePercentage = amount > 0 ? taxableAmount / amount : 0;
        const discountForTaxable = discount * taxablePercentage;
        const taxableDiscounted = Math.max(0, taxableAmount - discountForTaxable);
        
        // Apply 2% tax only to Gold/Diamond ornaments + Raw metals
        autoTax = taxableDiscounted * 0.02;
        // Reset manual flag because we're auto-calculating
        if (taxField) taxField.dataset.manual = 'false';
    }

    // Always reflect the current tax in the input (covers both manual and auto cases)
    if (taxField) {
        taxField.value = autoTax.toFixed(2);
    }

    // Sync hidden Django subtotal field (amount - discount)
    const hiddenSubtotalField = document.querySelector('input[name="subtotal"]');
    if (hiddenSubtotalField) {
        hiddenSubtotalField.value = discountedAmount.toFixed(2);
    }

    // Calculate final total: (amount - discount) + tax
    const total = discountedAmount + autoTax;

    // Update total display
    const totalField = document.getElementById('order-total');
    if (totalField) {
        totalField.value = Math.max(0, total).toFixed(2);
    }

    // Update remaining amount based on payment_amount
    updateRemainingAmount(total);

    // Also update the hidden form field for total if it exists
    const orderTotalField = document.querySelector('input[name="total"]');
    if (orderTotalField) {
        orderTotalField.value = Math.max(0, total).toFixed(2);
    }

}

function updateRemainingAmount(totalValue, paymentTotalOverride) {
    let paymentVal;
    if (typeof paymentTotalOverride === 'number') {
        paymentVal = paymentTotalOverride;
    } else {
        paymentVal = getPaymentRowsData().reduce((sum, row) => sum + (row.amount || 0), 0);
    }
    const remaining = Math.max(0, totalValue - paymentVal);

    const remainingDisplay = document.getElementById('payment-remaining-display');
    if (remainingDisplay) remainingDisplay.textContent = remaining.toFixed(2);

    const remainingField = document.getElementById('payment-remaining');
    if (remainingField) {
        remainingField.value = remaining.toFixed(2);
    }
}

function removeOrnament(ornamentId) {
    delete selectedOrnaments[ornamentId];
    const row = document.getElementById(`ornament-row-${ornamentId}`);
    if (row) row.remove();
    updateHiddenField();
    refreshSerialNumbers();
    // Recalculate totals after removing an ornament
    updateOrderTotal();
}

function updateHiddenField() {
    const ids = Object.keys(selectedOrnaments);
    let hiddenField = document.querySelector('select[name="existing_ornaments"]');
    
    // Create hidden field if it doesn't exist
    if (!hiddenField) {
        hiddenField = document.createElement('select');
        hiddenField.name = 'existing_ornaments';
        hiddenField.multiple = true;
        hiddenField.style.display = 'none';
        document.querySelector('form').appendChild(hiddenField);
    }
    
    hiddenField.innerHTML = '';
    ids.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.selected = true;
        option.textContent = selectedOrnaments[id].code;
        hiddenField.appendChild(option);
    });
}

function buildOrderLinesPayload() {
    const lines = [];
    Object.keys(selectedOrnaments).forEach(id => {
        const ornament = selectedOrnaments[id];
        const goldRateInput = document.querySelector(`.gold-rate-input[data-id="${id}"]`);
        const diamondRateInput = document.querySelector(`.diamond-rate-input[data-id="${id}"]`);
        const zirconRateInput = document.querySelector(`.zircon-rate-input[data-id="${id}"]`);
        const stoneRateInput = document.querySelector(`.stone-rate-input[data-id="${id}"]`);
        const jartiInput = document.querySelector(`.jarti-input[data-id="${id}"]`);
        const jyalaInput = document.querySelector(`.jyala-input[data-id="${id}"]`);
        const subtotalDisplay = document.querySelector(`.subtotal-display[data-id="${id}"]`);

        const line = {
            ornament_id: parseInt(id),
            gold_rate: parseFloat(goldRateInput?.value) || 0,
            diamond_rate: parseFloat(diamondRateInput?.value) || 0,
            zircon_rate: parseFloat(zirconRateInput?.value) || 0,
            stone_rate: parseFloat(stoneRateInput?.value) || 0,
            jarti: parseFloat(jartiInput?.value) || 0,
            jyala: parseFloat(jyalaInput?.value) || 0,
            line_amount: parseFloat(subtotalDisplay?.value) || 0,
        };
        lines.push(line);
    });

    const hiddenJsonField = document.querySelector('input[name="order_lines_json"]');
    if (hiddenJsonField) {
        hiddenJsonField.value = JSON.stringify(lines);
    }
}

function getPaymentRowsData() {
    const rows = [];
    const paymentRows = document.querySelectorAll('.payment-row');
    paymentRows.forEach((row, index) => {
        const modeSelect = row.querySelector('.payment-mode');
        const amountInput = row.querySelector('.payment-amount');
        
        const rawModeValue = modeSelect?.value;
        const rawAmountValue = amountInput?.value;
        const mode = rawModeValue || 'cash';
        const amountVal = parseFloat(rawAmountValue) || 0;
        
        rows.push({ 
            payment_mode: mode, 
            amount: amountVal
        });
    });
    return rows;
}

function recalcPayments() {
    const rows = getPaymentRowsData();
    // Keep rows that have a selected mode even if amount is 0, so backend can auto-fill mode
    const modeRows = rows.filter(r => !!r.payment_mode);
    // Only rows with a positive amount contribute to paid totals
    const paidRows = modeRows.filter(r => (r.amount || 0) > 0);
    
    const totalPaid = paidRows.reduce((sum, row) => sum + (row.amount || 0), 0);

    const hiddenAmount = document.querySelector('input[name="payment_amount"]');
    if (hiddenAmount) {
        hiddenAmount.value = totalPaid.toFixed(2);
    }

    const hiddenJson = document.querySelector('input[name="payment_lines_json"]');
    if (hiddenJson) {
        // Send all rows with selected modes (even zero amounts) so backend can auto-fill
        hiddenJson.value = JSON.stringify(modeRows);
    }

    const totalPaidDisplay = document.getElementById('payment-total-display');
    if (totalPaidDisplay) totalPaidDisplay.textContent = totalPaid.toFixed(2);

    const orderTotalVal = parseFloat(document.getElementById('order-total')?.value) || 0;
    updateRemainingAmount(orderTotalVal, totalPaid);
}

// Payments (multiple rows)
function addPaymentRow(mode = 'cash', amount = '') {
    const tbody = document.getElementById('payment-rows-body');
    if (!tbody) return;

    const row = document.createElement('tr');
    row.className = 'payment-row';
    row.innerHTML = `
        <td>
            <select class="form-select form-select-sm payment-mode">
                ${paymentModeOptionsHtml}
            </select>
        </td>
        <td>
            <input type="number" step="0.01" class="form-control form-control-sm payment-amount" placeholder="0.00">
        </td>
        <td class="text-end">
            <button type="button" class="btn btn-outline-danger btn-sm payment-remove">Remove</button>
        </td>
    `;
    tbody.appendChild(row);

    const modeSelect = row.querySelector('.payment-mode');
    const amountInput = row.querySelector('.payment-amount');
    const removeBtn = row.querySelector('.payment-remove');

    // Set values after DOM is ready - use setTimeout to ensure options are parsed
    setTimeout(() => {
        if (modeSelect && mode) {
            modeSelect.value = mode;
            console.log('[DEBUG] addPaymentRow - set mode to:', mode, 'actual value:', modeSelect.value);
        }
        if (amountInput && amount !== '') {
            amountInput.value = amount;
            console.log('[DEBUG] addPaymentRow - set amount to:', amount, 'actual value:', amountInput.value);
        }
        
        // Call recalcPayments after values are set
        recalcPayments();
    }, 0);

    // Handle payment mode changes
    modeSelect?.addEventListener('change', function() {
        // Just recalc; no auto-fill on mode change
        recalcPayments();
    });

    amountInput?.addEventListener('input', recalcPayments);

    removeBtn?.addEventListener('click', () => {
        // Keep at least one row; if only one, just clear its values
        const rows = document.querySelectorAll('.payment-row');
        if (rows.length <= 1) {
            if (modeSelect) modeSelect.value = 'cash';
            if (amountInput) amountInput.value = '';
        } else {
            row.remove();
        }
        recalcPayments();
    });

    // Don't call recalcPayments here - it's called in setTimeout after values are set
}


function initPaymentRows() {
    if (initialPayments && initialPayments.length) {
        initialPayments.forEach(payment => {
            addPaymentRow(payment.payment_mode || 'cash', payment.amount ?? '');
        });
    } else {
        addPaymentRow('cash', '');
    }
}

// Jarti Percentage Functions
function calculateJartiFromPercentage(percentage) {
    const ornamentIds = Object.keys(selectedOrnaments);
    if (ornamentIds.length === 0) {
        alert('Please select ornaments first');
        return;
    }
    // For each selected ornament, set its jarti = percentage * ornament weight
    ornamentIds.forEach(id => {
        const weight = selectedOrnaments[id].weight || 0;
        const jartiValue = (percentage / 100) * weight;
        const jartiInput = document.querySelector(`.jarti-input[data-id="${id}"]`);
        if (jartiInput) jartiInput.value = jartiValue.toFixed(3);
    });

    // Trigger recalculation for all ornaments
    triggerAllOrnamentRecalculation();
}

// Calculate Jarti for a single ornament (percentage applies to that ornament's weight)
function calculateJartiForOrnament(ornamentId, percentage) {
    const ornament = selectedOrnaments[ornamentId];
    if (!ornament) return;
    const weight = ornament.weight || 0;
    const jartiValue = (percentage / 100) * weight;
    const jartiInput = document.querySelector(`.jarti-input[data-id="${ornamentId}"]`);
    if (jartiInput) {
        jartiInput.value = jartiValue.toFixed(3);
        jartiInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

// Calculate Jyala for a single ornament (weight * 2000)
function calculateJyalaForOrnament(ornamentId) {
    const ornament = selectedOrnaments[ornamentId];
    if (!ornament) return;
    const weight = ornament.weight || 0;
    const jyalaValue = weight * 2000;
    const jyalaInput = document.querySelector(`.jyala-input[data-id="${ornamentId}"]`);
    if (jyalaInput) {
        jyalaInput.value = jyalaValue.toFixed(2);
        jyalaInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

function applyCustomJarti() {
    const customPercentage = parseFloat(document.getElementById('jarti-custom-percentage').value);
    
    if (isNaN(customPercentage) || customPercentage < 0) {
        alert('Please enter a valid percentage');
        return;
    }
    
    calculateJartiFromPercentage(customPercentage);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('jartiCustomModal'));
    if (modal) {
        modal.hide();
    }
    
    // Clear input for next use
    document.getElementById('jarti-custom-percentage').value = '';
}

function triggerAllOrnamentRecalculation() {
    // Trigger recalculation for all selected ornaments (rates, jarti, jyala)
    document.querySelectorAll('.gold-rate-input, .diamond-rate-input, .zircon-rate-input, .stone-rate-input, .jarti-input, .jyala-input').forEach(input => {
        input.dispatchEvent(new Event('input', { bubbles: true }));
    });
}

// Jyala Auto-Calculate Function
function calculateJyalaAuto() {
    const ornamentIds = Object.keys(selectedOrnaments);
    if (ornamentIds.length === 0) {
        alert('Please select ornaments first');
        return;
    }
    // For each selected ornament set jyala = weight * 2000
    ornamentIds.forEach(id => {
        const weight = selectedOrnaments[id].weight || 0;
        const jyalaValue = weight * 2000;
        const jyalaInput = document.querySelector(`.jyala-input[data-id="${id}"]`);
        if (jyalaInput) jyalaInput.value = jyalaValue.toFixed(2);
    });

    // Trigger recalculation for all ornaments
    triggerAllOrnamentRecalculation();
}

function addRow() {
    const totalForms = document.querySelector("#id_ornament_set-TOTAL_FORMS");
    const newIndex = parseInt(totalForms.value);
    
    const row = `
        <tr class="ornament-formset-row" data-row-index="${newIndex}">
            <td><input type="text" name="ornament_set-${newIndex}-ornament_name" class="form-control"></td>
            <td><select name="ornament_set-${newIndex}-metal_type" class="form-control">
                <option value="">---------</option>
                <option value="Gold">Gold</option>
                <option value="Silver">Silver</option>
            </select></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-weight" class="form-control weight-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-jarti" class="form-control jarti-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-jyala" class="form-control jyala-input" data-index="${newIndex}"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-rate" class="form-control rate-input" data-index="${newIndex}"></td>
            <td><input type="text" name="ornament_set-${newIndex}-size" class="form-control"></td>
            <td><input type="text" name="ornament_set-${newIndex}-stone" class="form-control"></td>
            <td><input type="number" step="0.01" name="ornament_set-${newIndex}-total" class="form-control subtotal-field" data-index="${newIndex}" readonly style="background-color: #f0f0f0;"></td>
            <td><input type="checkbox" name="ornament_set-${newIndex}-DELETE"></td>
        </tr>
    `;

    document.querySelector("#ornament-formset-body").insertAdjacentHTML("beforeend", row);
    totalForms.value = newIndex + 1;
    
    // Attach event listeners for calculation
    attachCalculationListeners(newIndex);
}

function attachCalculationListeners(index) {
    const weightInput = document.querySelector(`input[name="ornament_set-${index}-weight"]`);
    const jartiInput = document.querySelector(`input[name="ornament_set-${index}-jarti"]`);
    const jyalaInput = document.querySelector(`input[name="ornament_set-${index}-jyala"]`);
    const rateInput = document.querySelector(`input[name="ornament_set-${index}-rate"]`);
    const subtotalField = document.querySelector(`input[name="ornament_set-${index}-total"]`);
    
    const calculateSubtotal = () => {
        const weight = parseFloat(weightInput?.value) || 0;
        const jarti = parseFloat(jartiInput?.value) || 0;
        const jyala = parseFloat(jyalaInput?.value) || 0;
        const rate = parseFloat(rateInput?.value) || 0;
        
        // Subtotal = (weight * rate) + jarti + jyala
        const subtotal = (weight * rate) + jarti + jyala;
        
        if (subtotalField) {
            subtotalField.value = subtotal.toFixed(2);
        }
        
        // Update order total
        updateOrderTotal();
    };
    
    weightInput?.addEventListener('input', calculateSubtotal);
    jartiInput?.addEventListener('input', calculateSubtotal);
    jyalaInput?.addEventListener('input', calculateSubtotal);
    rateInput?.addEventListener('input', calculateSubtotal);
}


function initFinancialFromHidden() {
    const hiddenAmount = document.querySelector('input[name="amount"]');
    const hiddenDiscount = document.querySelector('input[name="discount"]');
    const hiddenTax = document.querySelector('input[name="tax"]');
    const hiddenTotal = document.querySelector('input[name="total"]');

    const amountVal = parseFloat(hiddenAmount?.value) || 0;
    const discountVal = parseFloat(hiddenDiscount?.value) || 0;
    const taxVal = parseFloat(hiddenTax?.value) || 0;
    const totalVal = parseFloat(hiddenTotal?.value) || 0;

    // If there is any non-zero financial data, prefer it (edit mode)
    if (amountVal || discountVal || taxVal || totalVal) {
        const amountField = document.getElementById('order-subtotal');
        if (amountField) amountField.value = amountVal.toFixed(2);

        const discountFieldVisible = document.getElementById('order-discount');
        if (discountFieldVisible) discountFieldVisible.value = discountVal.toFixed(2);

        const taxFieldVisible = document.getElementById('order-tax');
        if (taxFieldVisible) {
            taxFieldVisible.value = taxVal.toFixed(2);
            taxFieldVisible.dataset.manual = taxVal > 0 ? 'true' : 'false';
        }

        const totalFieldVisible = document.getElementById('order-total');
        if (totalFieldVisible) totalFieldVisible.value = totalVal.toFixed(2);

        const discountedField = document.getElementById('order-discounted-amount');
        if (discountedField) discountedField.value = (amountVal - discountVal).toFixed(2);

        // Update remaining based on current payment rows
        const baseTotal = totalVal || (amountVal - discountVal + taxVal);
        updateRemainingAmount(baseTotal || 0);
    }
}



// Attach listeners to existing rows on page load
document.addEventListener('DOMContentLoaded', function() {
    // For edit view, load ornaments already attached to this order
    initExistingOrnaments();

    // Initialize payment rows
    initPaymentRows();
    document.getElementById('add-payment-row')?.addEventListener('click', () => addPaymentRow());

    document.querySelectorAll('.ornament-formset-row').forEach(row => {
        const index = row.getAttribute('data-row-index');
        if (index) {
            attachCalculationListeners(index);
        }
    });
    
    // Add event listeners for jarti percentage buttons
    document.querySelectorAll('.jarti-percentage').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const percentage = parseInt(this.getAttribute('data-percentage'));
            calculateJartiFromPercentage(percentage);
            
            // Update button styling
            document.querySelectorAll('.jarti-percentage').forEach(b => {
                b.classList.remove('active');
                b.style.backgroundColor = '';
                b.style.color = '';
            });
            this.classList.add('active');
            this.style.backgroundColor = '#0d6efd';
            this.style.color = 'white';
        });
    });
    
    // Add event listener for jyala auto-calculate button
    document.getElementById('jyala-auto-calc-btn')?.addEventListener('click', function(e) {
        e.preventDefault();
        calculateJyalaAuto();
    });
    
    // Recalculate when discount or tax changes (only update derived fields, not Amount)
    // IMPORTANT: Only call updateDiscountAndTax, NOT updateOrderTotal
    const discountField = document.getElementById('order-discount');
    const taxField = document.getElementById('order-tax');
    
    if (discountField) {
        discountField.addEventListener('input', function() {
            const amount = parseFloat(document.getElementById('order-subtotal')?.value) || 0;
            updateDerivedFields(amount);
        });
    }
    
    if (taxField) {
        // Mark manual when user types a positive value; clear manual when zero/empty
        taxField.addEventListener('input', function() {
            const val = parseFloat(this.value);
            this.dataset.manual = val > 0 ? 'true' : 'false';
            const amount = parseFloat(document.getElementById('order-subtotal')?.value) || 0;
            updateDerivedFields(amount);
        });
    }

    // Initial financial values: prefer existing saved data (edit)
    // For new orders, this will just keep zeros until ornaments are added.
    initFinancialFromHidden();
    recalcPayments();

    // Form submit handler to sync all calculated values
    const orderForm = document.getElementById('order-form');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            console.log('[FORM SUBMIT] ========== FORM SUBMISSION HANDLER CALLED ==========');
            
            const customerNameInput = document.getElementById('id_customer_name');
            const phoneInput = document.getElementById('id_phone_number');
            const customerName = customerNameInput?.value.trim();
            const phone = phoneInput?.value.trim();
            if (!customerName || !phone) {
                e.preventDefault();
                alert('Customer name and phone number are required.');
                customerNameInput?.focus();
                return;
            }

            // Sync calculated values to form fields before submission
            const totalField = document.querySelector('input[name="total"]');
            const orderTotal = document.getElementById('order-total')?.value || '0.00';
            if (totalField) {
                totalField.value = orderTotal;
            }

            // Ensure discount is synced
            const discountField = document.querySelector('input[name="discount"]');
            const orderDiscount = document.getElementById('order-discount')?.value || '0.00';
            if (discountField) {
                discountField.value = orderDiscount;
            }

            // Ensure tax is synced
            const taxField = document.querySelector('input[name="tax"]');
            const orderTax = document.getElementById('order-tax')?.value || '0.00';
            if (taxField) {
                taxField.value = orderTax;
            }

            // Build JSON payload for per-ornament lines
            buildOrderLinesPayload();

            console.log('[FORM SUBMIT] About to examine payment rows...');
            const paymentRows = document.querySelectorAll('.payment-row');
            console.log('[FORM SUBMIT] Found', paymentRows.length, 'payment rows');
            
            // AUTO-FILL: Only if total paid is zero, set the FIRST row to order total
            const orderTotalVal = parseFloat(document.getElementById('order-total')?.value) || 0;
            let totalPaidBeforeSubmit = 0;
            paymentRows.forEach(row => {
                const amountInput = row.querySelector('.payment-amount');
                totalPaidBeforeSubmit += parseFloat(amountInput?.value) || 0;
            });

            if (totalPaidBeforeSubmit === 0 && orderTotalVal > 0.01 && paymentRows.length) {
                const firstRowAmount = paymentRows[0].querySelector('.payment-amount');
                if (firstRowAmount) {
                    firstRowAmount.value = orderTotalVal.toFixed(2);
                    console.log(`[FORM SUBMIT] Auto-filled first payment row with order total: ${orderTotalVal}`);
                }
            }
            
            // Recalculate payments AFTER any auto-fill is done
            console.log('[FORM SUBMIT] Calling recalcPayments after auto-fill...');
            recalcPayments();

            // FINAL SYNC: rebuild payment JSON directly from DOM to avoid any stale state
            const finalRows = getPaymentRowsData();
            const finalJsonField = document.querySelector('input[name="payment_lines_json"]');
            if (finalJsonField) {
                // Always send all rows (including zero amounts) so backend can auto-fill remaining into chosen modes
                finalJsonField.value = JSON.stringify(finalRows);
                console.log('[FORM SUBMIT] FINAL payment_lines_json value:', finalJsonField.value);
            }

            const finalPaidTotal = finalRows.reduce((sum, r) => sum + (r.amount || 0), 0);
            const finalPaidField = document.querySelector('input[name="payment_amount"]');
            if (finalPaidField) {
                finalPaidField.value = finalPaidTotal.toFixed(2);
                console.log('[FORM SUBMIT] FINAL payment_amount:', finalPaidField.value);
            }
            
            // Debug: Log the final payment_lines_json value being submitted
            const finalPaymentJson = document.querySelector('input[name="payment_lines_json"]');
            console.log('[FORM SUBMIT] payment_lines_json field exists:', !!finalPaymentJson);
            console.log('[FORM SUBMIT] payment_lines_json value:', finalPaymentJson?.value);
            
            const finalPaymentAmount = document.querySelector('input[name="payment_amount"]');
            console.log('[FORM SUBMIT] payment_amount:', finalPaymentAmount?.value);

            console.log('[FORM SUBMIT] Form submitted with total:', orderTotal, 'discount:', orderDiscount, 'tax:', orderTax);
            console.log('[FORM SUBMIT] ========== SUBMITTING FORM ==========');
        });
    }

    // Initialize metal row listeners and calculations
    initializeMetalStocks();
});

function deleteRow(btn) {
    btn.closest("tr").remove();
}

// Metal Stocks Formset Management
let metalRowCount = document.querySelectorAll('.metal-stock-row').length;

function updateMetalLineAmount(row) {
    const quantity = parseFloat(row.querySelector('.quantity')?.value) || 0;
    const rate = parseFloat(row.querySelector('.rate')?.value) || 0;
    const lineAmount = quantity * rate;
    row.querySelector('.line-amount').value = lineAmount.toFixed(2);
    updateMetalWeight();  // Update total metal weight
    updateOrderTotal();  // Recalculate entire order total
}

function updateMetalWeight() {
    let totalWeight = 0;
    document.querySelectorAll('.metal-stock-row:not([data-deleted]) .quantity').forEach(field => {
        totalWeight += parseFloat(field.value) || 0;
    });
    const weightField = document.getElementById('total-metal-weight');
    if (weightField) {
        weightField.value = totalWeight.toFixed(3);
    }
}

function addMetalRow() {
    const table = document.getElementById('metal-stocks-table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'metal-stock-row';
    newRow.setAttribute('data-form-index', metalRowCount);
    
    // Get the formset prefix from the page
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    let prefix = 'order_metals';
    if (totalFormsInput) {
        const name = totalFormsInput.getAttribute('name');
        prefix = name.replace('-TOTAL_FORMS', '');
    }
    
    newRow.innerHTML = `
        <td>
            <select name="${prefix}-${metalRowCount}-metal_type" class="form-select form-select-sm metal-type">
                <option value="">-- Select Metal --</option>
                <option value="gold">Gold</option>
                <option value="silver">Silver</option>
                <option value="platinum">Platinum</option>
            </select>
        </td>
        <td>
            <select name="${prefix}-${metalRowCount}-purity" class="form-select form-select-sm purity">
                <option value="">-- Select Purity --</option>
                <option value="24K">24K</option>
                <option value="22K">22K</option>
                <option value="20K">20K</option>
                <option value="18K">18K</option>
                <option value="14K">14K</option>
            </select>
        </td>
        <td>
            <input type="number" step="0.001" name="${prefix}-${metalRowCount}-quantity" class="form-control form-control-sm quantity" placeholder="0.000">
        </td>
        <td>
            <input type="number" step="0.01" name="${prefix}-${metalRowCount}-rate_per_gram" class="form-control form-control-sm rate" placeholder="0.00">
        </td>
        <td>
            <input type="text" name="${prefix}-${metalRowCount}-remarks" class="form-control form-control-sm remarks" placeholder="Notes...">
        </td>
        <td>
            <input type="number" step="0.01" class="form-control form-control-sm line-amount" value="0.00" readonly style="background-color: #f0f0f0;">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-metal-row" title="Remove this metal">×</button>
            <input type="hidden" name="${prefix}-${metalRowCount}-DELETE" class="delete-checkbox" value="">
        </td>
    `;
    
    tbody.appendChild(newRow);
    metalRowCount++;
    
    // Update TOTAL_FORMS in the management form
    const totalFormsField = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    if (totalFormsField) {
        totalFormsField.value = metalRowCount;
    }
    
    // Attach listeners to new row
    newRow.querySelector('.quantity').addEventListener('input', () => updateMetalLineAmount(newRow));
    newRow.querySelector('.rate').addEventListener('input', () => updateMetalLineAmount(newRow));
    newRow.querySelector('.remove-metal-row').addEventListener('click', (e) => {
        e.preventDefault();
        removeMetalRow(newRow);
    });
}

function removeMetalRow(row) {
    const deleteCheckbox = row.querySelector('.delete-checkbox');
    if (deleteCheckbox) {
        deleteCheckbox.value = 'on';
    }
    row.setAttribute('data-deleted', 'true');
    row.style.display = 'none';
    
    // Get the formset prefix
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    let prefix = 'order_metals';
    if (totalFormsInput) {
        const name = totalFormsInput.getAttribute('name');
        prefix = name.replace('-TOTAL_FORMS', '');
    }
    
    // Update TOTAL_FORMS in the management form
    const totalFormsField = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    if (totalFormsField && metalRowCount > 0) {
        metalRowCount--;
        totalFormsField.value = metalRowCount;
    }
    
    updateMetalWeight();  // Update total metal weight
    updateOrderTotal();  // Recalculate order total
}

// Initialize metal row listeners
function initializeMetalStocks() {
    // Attach listeners to existing metal rows
    document.querySelectorAll('.metal-stock-row').forEach(row => {
        row.querySelector('.quantity')?.addEventListener('input', () => updateMetalLineAmount(row));
        row.querySelector('.rate')?.addEventListener('input', () => updateMetalLineAmount(row));
        row.querySelector('.remove-metal-row')?.addEventListener('click', (e) => {
            e.preventDefault();
            removeMetalRow(row);
        });
        updateMetalLineAmount(row); // Calculate initial line amount
    });
    
    // Attach listener to add metal row button
    document.getElementById('add-metal-row')?.addEventListener('click', (e) => {
        e.preventDefault();
        addMetalRow();
    });

    // Update metal weight display
    updateMetalWeight();
    
    // Trigger overall update to recalculate totals including metals
    updateOrderTotal();
}
</script>
<script>
// --- Auto-calculate line amount for metal stock rows ---
function calculateLineAmount(row) {
    const qtyInput = row.querySelector('.quantity');
    const rateInput = row.querySelector('.rate');
    const unitSelect = row.querySelector('select[name$="rate_unit"]');
    const lineAmountInput = row.querySelector('.line-amount');
    if (!qtyInput || !rateInput || !unitSelect || !lineAmountInput) return;
    const qty = parseFloat(qtyInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    const unit = unitSelect.value;
    let amount = 0;
    if (qty && rate) {
        if (unit === 'gram') {
            amount = qty * rate;
        } else if (unit === '10gram') {
            amount = (qty / 10) * rate;
        } else if (unit === 'tola') {
            amount = (qty / 11.664) * rate;
        } else {
            amount = qty * rate;
        }
    }
    lineAmountInput.value = amount.toFixed(2);
    // Trigger financial summary update
    if (typeof updateOrderTotal === 'function') updateOrderTotal();
}

function setupMetalRowCalculation(row) {
    const qtyInput = row.querySelector('.quantity');
    const rateInput = row.querySelector('.rate');
    const unitSelect = row.querySelector('select[name$="rate_unit"]');
    if (qtyInput) qtyInput.addEventListener('input', () => calculateLineAmount(row));
    if (rateInput) rateInput.addEventListener('input', () => calculateLineAmount(row));
    if (unitSelect) unitSelect.addEventListener('change', () => calculateLineAmount(row));
    // Also trigger updateOrderTotal on change
    if (qtyInput) qtyInput.addEventListener('input', () => { if (typeof updateOrderTotal === 'function') updateOrderTotal(); });
    if (rateInput) rateInput.addEventListener('input', () => { if (typeof updateOrderTotal === 'function') updateOrderTotal(); });
    if (unitSelect) unitSelect.addEventListener('change', () => { if (typeof updateOrderTotal === 'function') updateOrderTotal(); });
    // Initial calculation
    calculateLineAmount(row);
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.metal-stock-row').forEach(row => {
        setupMetalRowCalculation(row);
    });
});
</script>

{% endblock %}
