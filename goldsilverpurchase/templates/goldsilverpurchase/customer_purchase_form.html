{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/css/nepali.datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/js/nepali.datepicker.min.js"></script>
<div class="container mt-5">
  <h1 class="text-center mb-4">{{ form_title }}</h1>

  <div class="alert alert-info" role="alert">
    <small><span class="text-danger fw-bold">*</span> indicates required fields</small>
  </div>

  <form method="post" class="row g-4" novalidate>
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <ul class="mb-0">
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% for field in form %}
          {% for error in field.errors %}
            <div class="alert alert-danger">{{ field.label }}: {{ error }}</div>
          {% endfor %}
        {% endfor %}
    {% csrf_token %}

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Customer & Purchase Information</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label mb-1">
              Purchase Date (BS)
                  Amount
            <input type="text" name="purchase_date" id="id_purchase_date" class="form-control form-control-sm {% if form.purchase_date.errors %}is-invalid{% endif %}" placeholder="YYYY-MM-DD (e.g., 2082-09-30)" value="{{ form.purchase_date.value|default:'' }}">
            <small class="text-muted">Optional: Nepali date in BS format</small>
          </div>

          <div class="mb-3">
            <label class="form-label mb-1">
              Customer Name <span class="text-danger fw-bold">*</span>
            <input type="text" name="customer_name" class="form-control form-control-sm {% if form.customer_name.errors %}is-invalid{% endif %}" value="{{ form.customer_name.value|default:'' }}" placeholder="Full name" required>
            {% if form.customer_name.errors %}<div class="text-danger small mt-1">{{ form.customer_name.errors }}</div>{% endif %}
          </div>

          <div class="mb-3">
          <label class="form-label mb-1">
              Metal Type <span class="text-danger fw-bold">*</span>
            <select name="metal_type" class="form-select form-select-sm {% if form.metal_type.errors %}is-invalid{% endif %}" required>
              <option value="">-- Select Metal Type --</option>
              {% for key, value in form.metal_type.field.choices %}
              <option value="{{ key }}" {% if form.metal_type.value == key %}selected{% endif %}>{{ value }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row g-3">
                        <div class="mb-3">
                          <label class="form-label mb-1">
                            Refined <span class="text-danger fw-bold">*</span>
                          </label>
                          <select name="refined_status" class="form-select form-select-sm {% if form.refined_status.errors %}is-invalid{% endif %}" required>
                            <option value="">-- Select Refined Status --</option>
                            {% for key, value in form.refined_status.field.choices %}
                            <option value="{{ key }}" {% if form.refined_status.value == key %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                          </select>
                          {% if form.refined_status.errors %}<div class="text-danger small mt-1">{{ form.refined_status.errors }}</div>{% endif %}
                        </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Location</label>
              <input type="text" name="location" class="form-control form-control-sm {% if form.location.errors %}is-invalid{% endif %}" value="{{ form.location.value|default:'' }}" placeholder="Location (optional)">
              {% if form.location.errors %}<div class="text-danger small mt-1">{{ form.location.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Phone No</label>
              <input type="text" name="phone_no" class="form-control form-control-sm {% if form.phone_no.errors %}is-invalid{% endif %}" value="{{ form.phone_no.value|default:'' }}" placeholder="Phone (optional)">
              {% if form.phone_no.errors %}<div class="text-danger small mt-1">{{ form.phone_no.errors }}</div>{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Ornament & Valuation Details</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label mb-1">
              Ornament Name <span class="text-danger fw-bold">*</span>
            </label>
            <input type="text" name="ornament_name" class="form-control form-control-sm {% if form.ornament_name.errors %}is-invalid{% endif %}" value="{{ form.ornament_name.value|default:'' }}" placeholder="e.g., Gold Bangle, Silver Ring" required>
            {% if form.ornament_name.errors %}<div class="text-danger small mt-1">{{ form.ornament_name.errors }}</div>{% endif %}
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label mb-1">
                Weight (तोल) <span class="text-danger fw-bold">*</span>
              </label>
              <input type="number" step="0.001" name="weight" id="id_weight" class="form-control form-control-sm {% if form.weight.errors %}is-invalid{% endif %}" value="{{ form.weight.value|default:'' }}" placeholder="0.000" required>
              {% if form.weight.errors %}<div class="text-danger small mt-1">{{ form.weight.errors }}</div>{% endif %}
              <small class="text-muted">Gross weight in तोल</small>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Percentage
              </label>
              <input type="number" step="0.01" name="percentage" id="id_percentage" class="form-control form-control-sm {% if form.percentage.errors %}is-invalid{% endif %}" value="{{ form.percentage.value|default:'' }}" placeholder="0.00">
              {% if form.percentage.errors %}<div class="text-danger small mt-1">{{ form.percentage.errors }}</div>{% endif %}
              <small class="text-muted">Loss/gain percentage (%)</small>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Final Weight (तोल)
              </label>
              <input type="number" step="0.001" name="final_weight" id="id_final_weight" class="form-control form-control-sm bg-light {% if form.final_weight.errors %}is-invalid{% endif %}" value="{{ form.final_weight.value|default:''|floatformat:'3' }}" placeholder="0.000" readonly>
              {% if form.final_weight.errors %}<div class="text-danger small mt-1">{{ form.final_weight.errors }}</div>{% endif %}
              <small class="text-muted">Final Weight = Weight - (Weight × Percentage / 100)</small>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label mb-1">
                Rate <span class="text-danger fw-bold">*</span>
              </label>
              <input type="number" step="0.01" name="rate" id="id_rate" class="form-control form-control-sm {% if form.rate.errors %}is-invalid{% endif %}" value="{{ form.rate.value|default:'' }}" placeholder="0.00" required>
              {% if form.rate.errors %}<div class="text-danger small mt-1">{{ form.rate.errors }}</div>{% endif %}
              <small class="text-muted">Price per unit</small>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Rate Unit <span class="text-danger fw-bold">*</span>
              </label>
              <select id="id_rate_unit" name="rate_unit" class="form-select form-select-sm {% if form.rate_unit.errors %}is-invalid{% endif %}" required>
                <option value="">Select Rate Unit</option>
                <option value="gram" {% if form.rate_unit.value == 'gram' %}selected{% endif %}>Per Gram</option>
                <option value="10gram" {% if form.rate_unit.value == '10gram' %}selected{% endif %}>Per 10 Gram</option>
                <option value="tola" {% if form.rate_unit.value == 'tola' %}selected{% endif %}>Per Tola</option>
              </select>
              {% if form.rate_unit.errors %}<div class="text-danger small mt-1">{{ form.rate_unit.errors }}</div>{% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Refined Weight (तोल) <span class="text-danger fw-bold">*</span>
              </label>
              <input type="number" step="0.001" name="refined_weight" class="form-control form-control-sm {% if form.refined_weight.errors %}is-invalid{% endif %}" value="{{ form.refined_weight.value|default:'' }}" placeholder="0.000" required>
              {% if form.refined_weight.errors %}<div class="text-danger small mt-1">{{ form.refined_weight.errors }}</div>{% endif %}
              <small class="text-muted">Net weight after refining</small>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label mb-1">
                Amount
              </label>
              <input type="number" step="0.01" name="amount" id="id_amount" class="form-control form-control-sm bg-light" value="{{ form.amount.value|default_if_none:'0.00' }}" placeholder="Auto-calculated" readonly>
              <small class="text-muted">(Refined Weight ÷ unit_conversion) × Rate (auto-calculated)</small>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Profit Weight (तोल)
              </label>
              <input type="number" step="0.001" name="profit_weight" id="id_profit_weight" class="form-control form-control-sm bg-light" value="{{ form.profit_weight.value|default_if_none:'0.000' }}" placeholder="Auto-calculated" readonly>
              <small class="text-muted">Refined Weight - Final Weight (auto-calculated)</small>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">
                Profit/Loss
              </label>
              <input type="number" step="0.01" name="profit" id="id_profit" class="form-control form-control-sm bg-light" value="{{ form.profit.value|default_if_none:'0.00' }}" placeholder="Auto-calculated" readonly>
              <small class="text-muted">(Profit Weight ÷ unit_conversion) × Rate (auto-calculated)</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 d-flex justify-content-end gap-2">
      <!-- Hidden fields for required model fields not shown in UI -->
      <input type="hidden" name="final_weight" id="id_final_weight_hidden" value="{{ form.final_weight.value|default:'' }}">
      <input type="hidden" name="amount" id="id_amount_hidden" value="{{ form.amount.value|default:'' }}">
      <input type="hidden" name="profit_weight" id="id_profit_weight_hidden" value="{{ form.profit_weight.value|default:'' }}">
      <input type="hidden" name="profit" id="id_profit_hidden" value="{{ form.profit.value|default:'' }}">
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check-circle me-1"></i>Save Purchase
      </button>
      <a href="{% url 'gsp:customer_purchase_list' %}" class="btn btn-secondary">
        <i class="bi bi-x-circle me-1"></i>Cancel
      </a>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/css/nepali.datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/js/nepali.datepicker.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', function () {
    console.log('DOMContentLoaded - Starting calculations');
    
    const options = { ndpYear: true, ndpMonth: true, ndpYearCount: 10 };
    if (typeof NepaliDatePicker !== 'undefined') {
      new NepaliDatePicker({ target: '#id_purchase_date', ...options });
    } else {
      console.warn('NepaliDatePicker is not loaded. Date picker will not be available.');
    }

    const $w = document.getElementById('id_weight');
    const $p = document.getElementById('id_percentage');
    const $fw = document.getElementById('id_final_weight');
    const $rw = document.querySelector('input[name="refined_weight"]');
    const $r = document.getElementById('id_rate');
    const $u = document.getElementById('id_rate_unit');
    const $a = document.getElementById('id_amount');
    const $pw = document.getElementById('id_profit_weight');
    const $pr = document.getElementById('id_profit');
    
    // Also update hidden fields for submission
    const $fw_hidden = document.getElementById('id_final_weight_hidden');
    const $a_hidden = document.getElementById('id_amount_hidden');
    const $pw_hidden = document.getElementById('id_profit_weight_hidden');
    const $pr_hidden = document.getElementById('id_profit_hidden');
    console.log('Form elements loaded:', {
      weight: !!$w, percentage: !!$p, finalWeight: !!$fw, refinedWeight: !!$rw,
      rate: !!$r, rateUnit: !!$u, amount: !!$a, profitWeight: !!$pw, profit: !!$pr,
      fw_hidden: !!$fw_hidden, a_hidden: !!$a_hidden, pw_hidden: !!$pw_hidden, pr_hidden: !!$pr_hidden
    });
    
    // Check if all elements exist
    if (!$w || !$p || !$fw || !$rw || !$r || !$u || !$a || !$pw || !$pr) {
      console.error('Missing form elements for calculation', {
        weight: !!$w, percentage: !!$p, finalWeight: !!$fw, refinedWeight: !!$rw,
        rate: !!$r, rateUnit: !!$u, amount: !!$a, profitWeight: !!$pw, profit: !!$pr
      });
      return;
    }
    
    function D(x){ const n = parseFloat(x); return isNaN(n) ? 0 : n; }
    
    function unitDivisor(){
      if ($u && $u.value === '10gram') return 10;
      if ($u && $u.value === 'tola') return 11.6643;
      return 1; // gram
    }
    
    function recalc(){
      try {
        const weight = D($w.value);
        const percentage = D($p.value);
        const rate = D($r.value);
        const refinedWeight = D($rw.value);
        
        console.log('Input values:', { weight, percentage, rate, refinedWeight });
        
        // Calculate final weight: weight - (weight * percentage / 100)
        const finalWeight = weight - (weight * percentage / 100);
        console.log('Final weight calculation: ' + weight + ' - (' + weight + ' * ' + percentage + ' / 100) = ' + finalWeight);
        
        $fw.value = (Math.max(0, finalWeight)).toFixed(3);
        if ($fw_hidden) $fw_hidden.value = $fw.value;
        
        // Calculate profit weight: refined_weight - final_weight
        const profitWeight = refinedWeight - finalWeight;
        $pw.value = profitWeight.toFixed(3);
        if ($pw_hidden) $pw_hidden.value = $pw.value;
        
        // Calculate amount based on refined_weight and rate_unit
        const divisor = unitDivisor();
        const amt = (Math.max(0, refinedWeight) / divisor) * rate;
        $a.value = Math.max(0, amt).toFixed(2);
        if ($a_hidden) $a_hidden.value = $a.value;
        
        // Calculate profit based on profit_weight and rate_unit
        const profitAmt = (profitWeight / divisor) * rate;
        $pr.value = profitAmt.toFixed(2);
        if ($pr_hidden) $pr_hidden.value = $pr.value;
        
        console.log('Calculation complete:', { finalWeight, profitWeight, amount: amt, profit: profitAmt });
      } catch (e) {
        console.error('Calculation error:', e);
      }
    }
    
    // Attach listeners and always recalc on input/change
    const elements = [$w, $p, $r, $u, $rw];
    elements.forEach(el => {
      if (el) {
        el.addEventListener('input', recalc);
        el.addEventListener('change', recalc);
      }
    });

    // Debug: log all values on every recalc
    function recalcWithDebug() {
      recalc();
      console.log('[DEBUG] After recalc:', {
        weight: $w.value,
        percentage: $p.value,
        finalWeight: $fw.value,
        refinedWeight: $rw.value,
        rate: $r.value,
        rateUnit: $u.value,
        amount: $a.value,
        profitWeight: $pw.value,
        profit: $pr.value
      });
    }
    elements.forEach(el => {
      if (el) {
        el.removeEventListener('input', recalc);
        el.removeEventListener('change', recalc);
        el.addEventListener('input', recalcWithDebug);
        el.addEventListener('change', recalcWithDebug);
      }
    });

    // Initial calculation with debug
    recalcWithDebug();
  });
</script>
{% endblock %}
