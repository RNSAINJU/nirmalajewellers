{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">{{ form_title }}</h1>

  <form method="post" class="row g-4" novalidate>
    {% csrf_token %}

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Customer & Purchase</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label mb-1">SN</label>
            <input type="text" name="sn" class="form-control form-control-sm" value="{{ form.sn.value|default:'' }}" required>
            {% if form.sn.errors %}<div class="text-danger small">{{ form.sn.errors }}</div>{% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label mb-1">Date (BS)</label>
            <input type="text" name="purchase_date" id="id_purchase_date" class="form-control form-control-sm" placeholder="YYYY-MM-DD" value="{{ form.purchase_date.value|default:'' }}">
            {% if form.purchase_date.errors %}<div class="text-danger small">{{ form.purchase_date.errors }}</div>{% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label mb-1">Customer Name</label>
            <input type="text" name="customer_name" class="form-control form-control-sm" value="{{ form.customer_name.value|default:'' }}" required>
            {% if form.customer_name.errors %}<div class="text-danger small">{{ form.customer_name.errors }}</div>{% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label mb-1">Metal Type</label>
            <select name="metal_type" class="form-select form-select-sm" required>
              {% for key, value in form.metal_type.field.choices %}
              <option value="{{ key }}" {% if form.metal_type.value == key %}selected{% endif %}>{{ value }}</option>
              {% endfor %}
            </select>
            {% if form.metal_type.errors %}<div class="text-danger small">{{ form.metal_type.errors }}</div>{% endif %}
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label mb-1">Location</label>
              <input type="text" name="location" class="form-control form-control-sm" value="{{ form.location.value|default:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Phone No</label>
              <input type="text" name="phone_no" class="form-control form-control-sm" value="{{ form.phone_no.value|default:'' }}">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Ornament Details</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label mb-1">Ornament Name</label>
            <input type="text" name="ornament_name" class="form-control form-control-sm" value="{{ form.ornament_name.value|default:'' }}" required>
            {% if form.ornament_name.errors %}<div class="text-danger small">{{ form.ornament_name.errors }}</div>{% endif %}
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label mb-1">Weight (tola)</label>
              <input type="number" step="0.001" name="weight" class="form-control form-control-sm" value="{{ form.weight.value|default:'' }}" required>
              {% if form.weight.errors %}<div class="text-danger small">{{ form.weight.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Refined Weight (tola)</label>
              <input type="number" step="0.001" name="refined_weight" class="form-control form-control-sm" value="{{ form.refined_weight.value|default:'' }}" required>
              {% if form.refined_weight.errors %}<div class="text-danger small">{{ form.refined_weight.errors }}</div>{% endif %}
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label mb-1">Rate</label>
              <input type="number" step="0.01" name="rate" id="id_rate" class="form-control form-control-sm" value="{{ form.rate.value|default:'' }}" required>
              {% if form.rate.errors %}<div class="text-danger small">{{ form.rate.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label mb-1">Amount</label>
              <input type="number" step="0.01" name="amount" id="id_amount" class="form-control form-control-sm bg-light" value="{{ form.amount.value|default:'' }}" placeholder="Auto-calculated" readonly>
              {% if form.amount.errors %}<div class="text-danger small">{{ form.amount.errors }}</div>{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-success me-2">Save</button>
      <a href="{% url 'gsp:customer_purchase_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/css/nepali.datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/js/nepali.datepicker.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', function () {
    const options = { ndpYear: true, ndpMonth: true, ndpYearCount: 10 };
    new NepaliDatePicker({ target: '#id_purchase_date', ...options });

    const $w = document.querySelector('input[name="weight"]');
    const $r = document.getElementById('id_rate');
    const $a = document.getElementById('id_amount');
    function D(x){ const n = parseFloat(x); return isNaN(n) ? 0 : n; }
    function recalc(){
      const amt = D($w.value) * D($r.value);
      $a.value = amt.toFixed(2);
    }
    [$w, $r].forEach(el => el && el.addEventListener('input', recalc));
    recalc();
  });
</script>
{% endblock %}
