{% extends 'base.html' %}
{% block content %}

<div class="container mt-5">
  <h1 class="text-center mb-4">{{ form_title }}</h1>

  <form method="post" novalidate class="row g-4">
    {% csrf_token %}

    <!-- Left: Bill & Party -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Bill & Party</div>
        <div class="card-body">
          <div class="mb-3">
            <label for="bill_no" class="form-label mb-1">Bill No</label>
            <input type="text" id="bill_no" name="bill_no" class="form-control form-control-sm" value="{{ form.bill_no.value|default:'' }}" placeholder="Bill number" required>
            {% if form.bill_no.errors %}<div class="text-danger small">{{ form.bill_no.errors }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label for="id_bill_date" class="form-label mb-1">Bill Date (BS)</label>
            <input type="text" id="id_bill_date" name="bill_date" class="form-control form-control-sm" placeholder="YYYY-MM-DD" value="{{ form.bill_date.value|default:'' }}" required>
            {% if form.bill_date.errors %}<div class="text-danger small">{{ form.bill_date.errors }}</div>{% endif %}
          </div>

          <div class="mb-3">
            <label for="party" class="form-label mb-1">Party</label>
            <div class="input-group input-group-sm">
              <select id="party" name="party" class="form-select form-select-sm" required>
                <option value="" disabled {% if not form.party.value %}selected{% endif %}>Select Party</option>
                {% for party in form.fields.party.queryset %}
                <option value="{{ party.pk }}" {% if form.party.value == party.pk %}selected{% endif %}>{{ party.party_name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#partiesModal" title="View All Parties">
                <i class="bi bi-list"></i>
              </button>
            </div>
            {% if form.party.errors %}<div class="text-danger small">{{ form.party.errors }}</div>{% endif %}
          </div>

          <div class="row g-2">
            <div class="col-md-6">
              <label for="metal_type" class="form-label mb-1">Metal Type</label>
              <select id="metal_type" name="metal_type" class="form-select form-select-sm" required>
                <option value="" disabled>Select Metal Type</option>
                {% for key, value in form.metal_type.field.choices %}
                <option value="{{ key }}" {% if form.metal_type.value == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
              {% if form.metal_type.errors %}<div class="text-danger small">{{ form.metal_type.errors }}</div>{% endif %}
            </div>

            <div class="col-md-6">
              <label for="id_purity" class="form-label mb-1">Purity</label>
              <select id="id_purity" name="purity" class="form-select form-select-sm" required>
                <option value="">Select Purity</option>
                <option value="24K" {% if form.purity.value == "24K" %}selected{% endif %}>24 Karat</option>
                <option value="22K" {% if form.purity.value == "22K" %}selected{% endif %}>22 Karat</option>
                <option value="18K" {% if form.purity.value == "18K" %}selected{% endif %}>18 Karat</option>
                <option value="14K" {% if form.purity.value == "14K" %}selected{% endif %}>14 Karat</option>
              </select>
              {% if form.purity.errors %}<div class="text-danger small">{{ form.purity.errors }}</div>{% endif %}
            </div>
          </div>

          <div class="mb-1">
            <label for="particular" class="form-label mb-1">Particular</label>
            <input id="particular" name="particular" class="form-control form-control-sm" value="{{ form.particular.value|default:'' }}" placeholder="Particular details" required>
            {% if form.particular.errors %}<div class="text-danger small">{{ form.particular.errors }}</div>{% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Amounts & Payment -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Amounts & Payment</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="quantity" class="form-label mb-1">Quantity</label>
              <input type="number" id="quantity" name="quantity" class="form-control form-control-sm" value="{{ form.quantity.value|default:'' }}" placeholder="Qty" step="0.001" required>
              {% if form.quantity.errors %}<div class="text-danger small">{{ form.quantity.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="rate" class="form-label mb-1">Rate</label>
              <input type="number" id="rate" name="rate" class="form-control form-control-sm" value="{{ form.rate.value|default:'' }}" placeholder="Rate" step="0.01" required>
              {% if form.rate.errors %}<div class="text-danger small">{{ form.rate.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="id_rate_unit" class="form-label mb-1">Rate Unit</label>
              <select id="id_rate_unit" name="rate_unit" class="form-select form-select-sm" required>
                <option value="">Select Rate Unit</option>
                <option value="gram" {% if form.rate_unit.value == 'gram' %}selected{% endif %}>Per Gram</option>
                <option value="10gram" {% if form.rate_unit.value == '10gram' %}selected{% endif %}>Per 10 Gram</option>
                <option value="tola" {% if form.rate_unit.value == 'tola' %}selected{% endif %}>Per Tola</option>
              </select>
              {% if form.rate_unit.errors %}<div class="text-danger small">{{ form.rate_unit.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="wages" class="form-label mb-1">Wages</label>
              <input type="number" id="wages" name="wages" class="form-control form-control-sm" value="{{ form.wages.value|default:'' }}" placeholder="Wages" step="0.01">
              {% if form.wages.errors %}<div class="text-danger small">{{ form.wages.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="discount" class="form-label mb-1">Discount</label>
              <input type="number" id="discount" name="discount" class="form-control form-control-sm" value="{{ form.discount.value|default:'' }}" placeholder="Discount" step="0.01">
              {% if form.discount.errors %}<div class="text-danger small">{{ form.discount.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="amount" class="form-label mb-1">Amount</label>
              <input type="number" id="amount" name="amount" class="form-control form-control-sm bg-light" value="{{ form.amount.value|default:'' }}" placeholder="Auto-calculated" step="0.01" readonly>
              {% if form.amount.errors %}<div class="text-danger small">{{ form.amount.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label for="payment_mode" class="form-label mb-1">Payment Mode</label>
              <select id="payment_mode" name="payment_mode" class="form-select form-select-sm" required>
                <option value="" disabled>Select Payment Mode</option>
                {% for key, value in form.payment_mode.field.choices %}
                <option value="{{ key }}" {% if form.payment_mode.value == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
              {% if form.payment_mode.errors %}<div class="text-danger small">{{ form.payment_mode.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch mt-4">
                <input type="checkbox" class="form-check-input" name="is_paid" id="id_is_paid" {% if form.is_paid.value %}checked{% endif %}>
                <label class="form-check-label" for="id_is_paid">Payment Completed</label>
              </div>
              {% if form.is_paid.errors %}<div class="text-danger small">{{ form.is_paid.errors }}</div>{% endif %}
            </div>
            <div class="col-12">
              <label for="id_remarks" class="form-label mb-1">Remarks</label>
              <textarea class="form-control form-control-sm" name="remarks" id="id_remarks" rows="3" placeholder="Notes...">{% if form.remarks.value %}{{ form.remarks.value }}{% endif %}</textarea>
              {% if form.remarks.errors %}<div class="text-danger small">{{ form.remarks.errors }}</div>{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-success me-2">Save</button>
      <a href="{% url 'gsp:purchaselist' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- Nepali Date Picker + auto amount calc -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/css/nepali.datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/nepali-datepicker-v3@3.7.0/dist/js/nepali.datepicker.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', function () {
    const options = { ndpYear: true, ndpMonth: true, ndpYearCount: 10 };
    new NepaliDatePicker({ target: '#id_bill_date', ...options });

    // Style purity select field
    const puritySelect = document.getElementById('id_purity');
    if (puritySelect) {
      puritySelect.classList.add('form-select', 'form-select-sm');
    }

    const $q = document.getElementById('quantity');
    const $r = document.getElementById('rate');
    const $u = document.getElementById('id_rate_unit');
    const $w = document.getElementById('wages');
    const $d = document.getElementById('discount');
    const $a = document.getElementById('amount');
    function D(x){ const n = parseFloat(x); return isNaN(n) ? 0 : n; }
    function unitMultiplier(){
      if ($u && $u.value === '10gram') return 1/10;
      if ($u && $u.value === 'tola') return 1/11.664;
      return 1;
    }
    function recalc(){
      const subtotal = D($q.value) * D($r.value) * unitMultiplier();
      const amt = subtotal + D($w.value) - D($d.value);
      $a.value = amt.toFixed(2);
    }
    [$q,$r,$w,$d,$u].forEach(el => el && el.addEventListener('input', recalc));
  });

  // Party selection from modal
  function selectParty(partyId, partyName) {
    document.getElementById('party').value = partyId;
    const modal = bootstrap.Modal.getInstance(document.getElementById('partiesModal'));
    if (modal) modal.hide();
  }

  // Toggle between parties list and add form
  function showAddPartyForm() {
    document.getElementById('partiesTableView').style.display = 'none';
    document.getElementById('partiesFormView').style.display = 'block';
  }

  function showPartiesList() {
    document.getElementById('partiesTableView').style.display = 'block';
    document.getElementById('partiesFormView').style.display = 'none';
    document.getElementById('addPartyForm').reset();
  }

  // Handle party form submission
  document.addEventListener('DOMContentLoaded', function() {
    const addPartyForm = document.getElementById('addPartyForm');
    if (addPartyForm) {
      addPartyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(addPartyForm);
        
        fetch('{% url "gsp:createparty" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: formData
        })
        .then(response => {
          if (response.ok) {
            // Reload the page to refresh the party list
            location.reload();
          } else {
            alert('Error adding party. Please check the form.');
          }
        })
        .catch(error => console.error('Error:', error));
      });
    }
  });
</script>

<!-- Parties Modal -->
<div class="modal fade" id="partiesModal" tabindex="-1" aria-labelledby="partiesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="partiesModalLabel">All Parties</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Parties Table View -->
        <div id="partiesTableView">
          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>Party Name</th>
                  <th>PAN No</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for party in form.fields.party.queryset %}
                <tr>
                  <td>{{ party.party_name }}</td>
                  <td>{{ party.panno }}</td>
                  <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="selectParty({{ party.pk }}, '{{ party.party_name }}')">
                      Select
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">No parties found</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Add Party Form View -->
        <div id="partiesFormView" style="display: none;">
          <form id="addPartyForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="newPartyName" class="form-label">Party Name</label>
              <input type="text" id="newPartyName" name="party_name" class="form-control" placeholder="Enter Party Name" required>
            </div>
            <div class="mb-3">
              <label for="newPartyPan" class="form-label">PAN No</label>
              <input type="text" id="newPartyPan" name="panno" class="form-control" placeholder="Enter 9-digit PAN" pattern="\d{9}" maxlength="9" required>
              <small class="text-muted">Must be 9 digits</small>
            </div>
          </form>
        </div>

      </div>
      <div class="modal-footer">
        <div id="tableFooter">
          <button type="button" class="btn btn-success btn-sm" onclick="showAddPartyForm()">+ Add New Party</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
        <div id="formFooter" style="display: none;">
          <button type="button" class="btn btn-secondary" onclick="showPartiesList()">Back to List</button>
          <button type="submit" form="addPartyForm" class="btn btn-success">Save Party</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Update footer buttons visibility when switching views
  const origShowAddForm = showAddPartyForm;
  showAddPartyForm = function() {
    origShowAddForm();
    document.getElementById('tableFooter').style.display = 'none';
    document.getElementById('formFooter').style.display = 'flex';
  };

  const origShowList = showPartiesList;
  showPartiesList = function() {
    origShowList();
    document.getElementById('tableFooter').style.display = 'flex';
    document.getElementById('formFooter').style.display = 'none';
  };
</script>
    recalc();
  });
  </script>

{% endblock %}