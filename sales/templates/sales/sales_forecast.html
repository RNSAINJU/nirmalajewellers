{% extends 'base.html' %}

{% block content %}
<style>
    .forecast-header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        padding: 24px;
        border-radius: 14px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
    }
    .metric-card {
        background: #fff;
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
        text-align: center;
        border: 1px solid #eef2f7;
    }
    .metric-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #64748b;
        margin-bottom: 6px;
        font-weight: 600;
    }
    .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
    }
    .section-card {
        background: #fff;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        margin-bottom: 24px;
        border: 1px solid #eef2f7;
    }
    .table thead th {
        background: #0f172a;
        color: #fff;
    }
    .hint {
        color: #475569;
        font-size: 13px;
    }
</style>

<div class="container mt-4">
    <div class="forecast-header">
        <h2 class="mb-1">Sales Forecasting</h2>
        <div class="opacity-75">Uses recent monthly sales to project future months.</div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">Last Month Total</div>
                <div class="metric-value">Rs {{ last_total|floatformat:2 }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">3-Month Avg</div>
                <div class="metric-value">Rs {{ recent_avg|floatformat:2 }}</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">Trend</div>
                <div class="metric-value">{{ trend_percent|floatformat:2 }}%</div>
            </div>
        </div>
    </div>

    <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Actual vs Forecast</h5>
            <div class="hint">Forecast uses a trend from the last 3 months vs previous 3 months.</div>
        </div>
        <canvas id="forecastChart" height="110"></canvas>
    </div>

    <div class="section-card">
        <h5 class="mb-3">Historical (Last 12 Months)</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Month/Year</th>
                        <th class="text-end">Total Sales (Rs)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in actual_points %}
                    <tr>
                        <td>{{ item.label }}</td>
                        <td class="text-end">{{ item.total|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center text-muted">No historical data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-card">
        <h5 class="mb-3">Forecast (Next 12 Months)</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Month/Year</th>
                        <th class="text-end">Projected Sales (Rs)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in forecast_points %}
                    <tr>
                        <td>{{ item.label }}</td>
                        <td class="text-end">{{ item.total|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center text-muted">No forecast data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
  {% include 'main/_chartjs_head.html' %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var ctx = document.getElementById('forecastChart');
      if (!ctx) return;
      var labels = {{ chart_labels_json|safe }};
      var actual = {{ chart_actual_json|safe }};
      var forecast = {{ chart_forecast_json|safe }};
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Actual',
              data: actual,
              borderColor: 'rgba(14, 116, 144, 1)',
              backgroundColor: 'rgba(14, 116, 144, 0.15)',
              tension: 0.3,
              spanGaps: false
            },
            {
              label: 'Forecast',
              data: forecast,
              borderColor: 'rgba(245, 158, 11, 1)',
              backgroundColor: 'rgba(245, 158, 11, 0.15)',
              borderDash: [6, 4],
              tension: 0.3,
              spanGaps: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) { return 'Rs ' + value; }
              }
            }
          }
        }
      });
    });
  </script>
{% endblock %}
