{% extends 'base.html' %}

{% block content %}
<style>
    .trend-header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        padding: 24px;
        border-radius: 14px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
    }
    .section-card {
        background: #fff;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        margin-bottom: 24px;
        border: 1px solid #eef2f7;
    }
    .table thead th {
        background: #0f172a;
        color: #fff;
    }
    .hint {
        color: #475569;
        font-size: 13px;
    }
</style>

<div class="container mt-4">
    <div class="trend-header">
        <h2 class="mb-1">Trend Analysis</h2>
        <div class="opacity-75">Track seasonal demand and shifting customer preferences.</div>
    </div>

    <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Seasonal Sales Trend (Last 12 Months)</h5>
            <div class="hint">Uses monthly order totals from recorded sales.</div>
        </div>
        <canvas id="trendChart" height="110"></canvas>
    </div>

    <div class="section-card">
        <h5 class="mb-3">Metal Preference</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Metal Type</th>
                        <th class="text-end">Units</th>
                        <th class="text-end">Weight</th>
                        <th class="text-end">Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in metal_breakdown %}
                    <tr>
                        <td>{{ row.ornament__metal_type }}</td>
                        <td class="text-end">{{ row.units }}</td>
                        <td class="text-end">{{ row.total_weight|floatformat:3 }}</td>
                        <td class="text-end">Rs {{ row.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-card">
        <h5 class="mb-3">Category Preference</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th class="text-end">Units</th>
                        <th class="text-end">Weight</th>
                        <th class="text-end">Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in category_breakdown %}
                    <tr>
                        <td>{{ row.ornament__maincategory__name|default:"Uncategorized" }}</td>
                        <td class="text-end">{{ row.units }}</td>
                        <td class="text-end">{{ row.total_weight|floatformat:3 }}</td>
                        <td class="text-end">Rs {{ row.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-card">
        <h5 class="mb-3">Popular Products</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Metal</th>
                        <th class="text-end">Units</th>
                        <th class="text-end">Weight</th>
                        <th class="text-end">Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in top_products %}
                    <tr>
                        <td>{{ row.ornament__ornament_name|default:"Unknown" }}</td>
                        <td>{{ row.ornament__metal_type }}</td>
                        <td class="text-end">{{ row.units }}</td>
                        <td class="text-end">{{ row.total_weight|floatformat:3 }}</td>
                        <td class="text-end">Rs {{ row.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
  {% include 'main/_chartjs_head.html' %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var ctx = document.getElementById('trendChart');
      if (!ctx) return;
      var labels = {{ chart_labels_json|safe }};
      var totals = {{ chart_totals_json|safe }};
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Monthly Sales',
              data: totals,
              borderColor: 'rgba(37, 99, 235, 1)',
              backgroundColor: 'rgba(37, 99, 235, 0.15)',
              tension: 0.35
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) { return 'Rs ' + value; }
              }
            }
          }
        }
      });
    });
  </script>
{% endblock %}
