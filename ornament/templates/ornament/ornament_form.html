{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">

    <h2 class="mb-4">
        {% if view.object %} Edit Ornament {% else %} Add New Ornament {% endif %}
    </h2>

    <!-- Create buttons -->
    <div class="d-flex justify-content-end mb-3 gap-2">
        <a href="{% url 'ornament:createkaligar' %}" class="btn btn-success">
            <i class="bi bi-person-plus-fill me-1"></i> Create Kaligar
        </a>

        <a href="{% url 'ornament:createmaincategory' %}" class="btn btn-success">
            <i class="bi bi-person-plus-fill me-1"></i> Create MainCategory
        </a>

        <a href="{% url 'ornament:createsubcategory' %}" class="btn btn-success">
            <i class="bi bi-person-plus-fill me-1"></i> Create Sub-Category
        </a>
    </div>
    <div class="card shadow">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Hidden status field - default to active -->
                <input type="hidden" name="status" value="active">
                <!-- Compact ornament header fields -->
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <div class="row g-2 align-items-end small">

                                    <!-- Ornament Date -->
                                    <div class="col-md-3 col-sm-4">
                                        <label class="form-label mb-1">Ornament Date</label>
                                        <input
                                            type="text"
                                            id="ornament_date"
                                            name="ornament_date"
                                            class="form-control form-control-sm nepali-date"
                                            value="{{ form.ornament_date.value|default:'' }}"
                                            placeholder="Date (YYYY-MM-DD)"
                                            required
                                        />
                                        {% if form.ornament_date.errors %}
                                            <div class="text-danger small">{{ form.ornament_date.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Ornament Type -->
                                    <div class="col-md-2 col-sm-4">
                                        <label class="form-label mb-1">Ornament Type</label>
                                        <select id="ornament_type" name="ornament_type" class="form-select form-select-sm" required>
                                            <option value="" disabled {% if not form.ornament_type.value %}selected{% endif %}>Select</option>
                                            {% for key, value in form.fields.ornament_type.choices %}
                                                <option value="{{ key }}" {% if form.ornament_type.value == key %}selected{% endif %}>{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.ornament_type.errors %}
                                            <div class="text-danger small">{{ form.ornament_type.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Metal Type -->
                                    <div class="col-md-2 col-sm-4">
                                        <label class="form-label mb-1">Metal Type</label>
                                        <select id="id_metal_type" name="metal_type" class="form-select form-select-sm" required>
                                            <option value="" disabled {% if not form.metal_type.value %}selected{% endif %}>Select</option>
                                            {% for key, value in form.fields.metal_type.choices %}
                                                <option value="{{ key }}" {% if form.metal_type.value == key %}selected{% endif %}>{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.metal_type.errors %}
                                            <div class="text-danger small">{{ form.metal_type.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Gold Type (Purity) -->
                                    <div class="col-md-2 col-sm-4">
                                        <label class="form-label mb-1">Gold Type</label>
                                        <select id="type" name="type" class="form-select form-select-sm" required>
                                            <option value="" disabled {% if not form.type.value %}selected{% endif %}>Select</option>
                                            {% for key, value in form.fields.type.choices %}
                                                <option value="{{ key }}" {% if form.type.value == key %}selected{% endif %}>{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                        {% if form.type.errors %}
                                            <div class="text-danger small">{{ form.type.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Main Category -->
                                    <div class="col-md-3 col-sm-6">
                                        <label class="form-label mb-1">Main Category</label>
                                        {{ form.maincategory }}
                                        {% if form.maincategory.errors %}
                                            <div class="text-danger small">{{ form.maincategory.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Sub-Category -->
                                    <div class="col-md-3 col-sm-6">
                                        <label class="form-label mb-1">Sub-Category</label>
                                        {{ form.subcategory }}
                                        {% if form.subcategory.errors %}
                                            <div class="text-danger small">{{ form.subcategory.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Ornament Code -->
                                    <div class="col-md-3 col-sm-6">
                                        <label class="form-label mb-1">Ornament Code</label>
                                        <input
                                            type="text"
                                            id="id_code_preview"
                                            class="form-control form-control-sm bg-light"
                                            placeholder="Auto-generated"
                                            readonly
                                            value="{% if form.instance.code %}{{ form.instance.code }}{% endif %}"
                                            {% if form.instance.code %}data-fixed="true"{% endif %}
                                        />
                                    </div>

                                    <!-- Ornament Name -->
                                    <div class="col-md-3 col-sm-6">
                                        <label class="form-label mb-1">Ornament Name</label>
                                        <input
                                            type="text"
                                            id="id_ornament_name"
                                            name="ornament_name"
                                            class="form-control form-control-sm"
                                            placeholder="Name"
                                            value="{{ form.ornament_name.value|default:'' }}"
                                            required
                                        />
                                        {% if form.ornament_name.errors %}
                                            <div class="text-danger small">{{ form.ornament_name.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Kaligar -->
                                    <div class="col-md-3 col-sm-6">
                                        <label class="form-label mb-1">Kaligar</label>
                                        {{ form.kaligar }}
                                        {% if form.kaligar.errors %}
                                            <div class="text-danger small">{{ form.kaligar.errors }}</div>
                                        {% endif %}
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed fields -->
                <div class="row g-3">

                    <!-- Weights & Stones card -->
                    <div class="col-lg-8">
                        <div class="card mb-3">
                            <div class="card-header py-1"><strong>Weights &amp; Stones</strong></div>
                            <div class="card-body py-2">
                                <div class="row g-2 small">
                                    <!-- Gross Weight -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Gross Weight (तोल)</label>
                                        <input
                                            type="number"
                                            id="gross_weight"
                                            name="gross_weight"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.gross_weight.value|default:'0.0' }}"
                                            placeholder="Gross weight"
                                            required
                                        />
                                        {% if form.weight.errors %}
                                            <div class="text-danger small">{{ form.gross_weight.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Metal Weight -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Metal Weight (तोल)</label>
                                        <input
                                            type="number"
                                            id="weight"
                                            name="weight"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.weight.value|default:'0.0' }}"
                                            placeholder="Metal weight"
                                            required
                                        />
                                        {% if form.weight.errors %}
                                            <div class="text-danger small">{{ form.weight.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Diamond Weight -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Diamond Weight</label>
                                        <input
                                            type="number"
                                            id="diamond_weight"
                                            name="diamond_weight"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.diamond_weight.value|default:'0.0' }}"
                                            placeholder="Diamond weight"
                                        />
                                        {% if form.diamond_weight.errors %}
                                            <div class="text-danger small">{{ form.diamond_weight.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Diamond Rate -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Diamond Rate</label>
                                        <input
                                            type="number"
                                            id="diamond_rate"
                                            name="diamond_rate"
                                            class="form-control form-control-sm"
                                            step="0.01"
                                            value="{{ form.diamond_rate.value|default:'0.0' }}"
                                            placeholder="Diamond rate"
                                        />
                                        {% if form.diamond_rate.errors %}
                                            <div class="text-danger small">{{ form.diamond_rate.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Zircon Weight -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Zircon Weight</label>
                                        <input
                                            type="number"
                                            id="zircon_weight"
                                            name="zircon_weight"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.zircon_weight.value|default:'0.0' }}"
                                            placeholder="Zircon weight"
                                        />
                                        {% if form.zircon_weight.errors %}
                                            <div class="text-danger small">{{ form.zircon_weight.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Stone Weight -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Stone Weight</label>
                                        <input
                                            type="number"
                                            id="stone_weight"
                                            name="stone_weight"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.stone_weight.value|default:'0.0' }}"
                                            placeholder="Stone weight"
                                        />
                                        {% if form.stone_weight.errors %}
                                            <div class="text-danger small">{{ form.stone_weight.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Stone per carat price -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Stone Price / Carat</label>
                                        <input
                                            type="number"
                                            id="stone_percaratprice"
                                            name="stone_percaratprice"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.stone_percaratprice.value|default:'0.0' }}"
                                            placeholder="Price per carat"
                                        />
                                        {% if form.stone_percaratprice.errors %}
                                            <div class="text-danger small">{{ form.stone_percaratprice.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Stone Total Price -->
                                    <div class="col-md-6 col-xl-4">
                                        <label class="form-label mb-1">Stone Total Price</label>
                                        <input
                                            type="number"
                                            id="stone_totalprice"
                                            name="stone_totalprice"
                                            class="form-control form-control-sm"
                                            step="0.001"
                                            value="{{ form.stone_totalprice.value|default:'0.0' }}"
                                            placeholder="Total price"
                                        />
                                        {% if form.stone_totalprice.errors %}
                                            <div class="text-danger small">{{ form.stone_totalprice.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Labour & Image card -->
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header py-1"><strong>Labour &amp; Image</strong></div>
                            <div class="card-body py-2 small">
                                <!-- Jarti Field -->
                                <div class="mb-2">
                                    <label for="jarti" class="form-label mb-1">Jarti</label>
                                    <input
                                        type="number"
                                        id="id_jarti"
                                        name="jarti"
                                        class="form-control form-control-sm"
                                        step="0.001"
                                        value="{{ form.jarti.value|default:'0.0' }}"
                                        placeholder="Enter Jarti"
                                    />
                                </div>

                                <!-- Jarti Buttons -->
                                <div class="mb-2">
                                    <label class="form-label mb-1">Quick Jarti %</label><br>
                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                        <button type="button" class="btn btn-outline-primary btn-sm jarti-btn" data-value="4.0">4%</button>
                                        <button type="button" class="btn btn-outline-primary btn-sm jarti-btn" data-value="4.5">4.5%</button>
                                        <button type="button" class="btn btn-outline-primary btn-sm jarti-btn" data-value="5.0">5%</button>
                                        <button type="button" class="btn btn-outline-primary btn-sm jarti-btn" data-value="6.5">6.5%</button>
                                        <button type="button" class="btn btn-outline-primary btn-sm jarti-btn" data-value="8.0">8%</button>
                                    </div>
                                </div>

                                <!-- Jyala Field -->
                                <div class="mb-3">
                                    <label for="id_jyala" class="form-label mb-1">Jyala</label>
                                    <div class="input-group input-group-sm">
                                        <input
                                            type="number"
                                            id="id_jyala"
                                            name="jyala"
                                            class="form-control"
                                            step="0.001"
                                            value="{{ form.jyala.value|default:'0.0' }}"
                                            placeholder="Jyala"
                                            readonly
                                        />
                                        <button class="btn btn-outline-secondary" id="calculateButton" type="button">Calculate</button>
                                    </div>
                                    {% if form.jyala.errors %}
                                        <div class="text-danger small">{{ form.jyala.errors }}</div>
                                    {% endif %}
                                </div>

                                <!-- Image -->
                                <div class="mb-2">
                                    <label class="form-label mb-1">Ornament Image</label>
                                    <div class="mb-2">
                                        {% if form.instance and form.instance.image %}
                                            <img id="image-preview" src="{{ form.instance.image.url }}"
                                                 alt="Current Image" style="max-width:200px; max-height:200px; margin-bottom:10px;">
                                        {% else %}
                                            <img id="image-preview" src="" alt="Preview" style="max-width:200px; max-height:200px; display:none; margin-bottom:10px;">
                                        {% endif %}
                                    </div>
                                    {{ form.image }}
                                    {% if form.image.errors %}
                                        <div class="text-danger small">{{ form.image.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    
                </div>

                <!-- Form Buttons -->
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">Save</button>
                    <a href="{% if request.GET.next %}{{ request.GET.next }}{% else %}{% url 'ornament:list' %}{% endif %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Style form selects -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("id_maincategory").classList.add("form-select", "form-select-sm");
    document.getElementById("id_subcategory").classList.add("form-select", "form-select-sm");
    document.getElementById("id_kaligar").classList.add("form-select", "form-select-sm");
});
</script>

<!-- Jarti Button Script -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
    
        const buttons = document.querySelectorAll(".jarti-btn");
        const jartiInput = document.getElementById("id_jarti");
        const weightInput = document.getElementById("weight");
    
        buttons.forEach(button => {
            button.addEventListener("click", function () {
    
                const percent = parseFloat(this.dataset.value);
                const weight = parseFloat(weightInput.value);
    
                if (!weight || weight <= 0) {
                    alert("Please enter Metal Weight first");
                    return;
                }
    
                const jarti = (weight * percent) / 100;
                jartiInput.value = jarti.toFixed(3);
    
                // Button highlight
                buttons.forEach(btn => {
                    btn.classList.remove("btn-primary");
                    btn.classList.add("btn-outline-primary");
                });
    
                this.classList.remove("btn-outline-primary");
                this.classList.add("btn-primary");
            });
        });
    
    });
    </script>

    <!-- Jyala javascript -->
<script>
document.getElementById("calculateButton").addEventListener("click", function() {
    // Get the value from the Gross Weight input
    const grossWeight = parseFloat(document.getElementById("weight").value) || 0;

    // Calculate Jyala
    const jyala = grossWeight * 1800;

    // Set the calculated value to the Jyala input field
    document.getElementById("id_jyala").value = jyala.toFixed(3); // Set to 3 decimal places
});

</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

const nameInput = document.getElementById("id_ornament_name");
const maincategorySelect = document.getElementById("id_maincategory");
const subcategorySelect = document.getElementById("id_subcategory");
const kaligarSelect = document.getElementById("id_kaligar");
const ornamentTypeSelect = document.getElementById("ornament_type");
const codePreview = document.getElementById("id_code_preview");
const objectPk = "{{ form.instance.pk|default_if_none:'' }}";
const form = document.querySelector('form');

let isSubmitting = false;

function generateCode() {
    // If a stored code exists, don't regenerate
    if (codePreview.dataset.fixed === "true") {
        return;
    }

    // Don't regenerate during form submission
    if (isSubmitting) {
        return;
    }

    if (
        !nameInput.value ||
        !maincategorySelect.value ||
        !subcategorySelect.value ||
        !kaligarSelect.value ||
        !ornamentTypeSelect.value
    ) {
        codePreview.value = "";
        return;
    }

    const nameLetter = nameInput.value.trim().charAt(0).toUpperCase();
    const maincategoryLetter =
    maincategorySelect.options[maincategorySelect.selectedIndex].text.trim().charAt(0).toUpperCase();
    const subcategoryLetter =
    subcategorySelect.options[subcategorySelect.selectedIndex].text.trim().charAt(0).toUpperCase();
    const kaligarLetter =
        kaligarSelect.options[kaligarSelect.selectedIndex].text.trim().charAt(0).toUpperCase();
    const ornamentTypeLetter =
        ornamentTypeSelect.options[ornamentTypeSelect.selectedIndex].text.trim().charAt(0).toUpperCase();

    const suffix = objectPk ? objectPk : "PK";
    // Match server-side pattern: Name, Subcategory, Maincategory, Kaligar, OrnamentType, ID
    codePreview.value = `${nameLetter}${subcategoryLetter}${maincategoryLetter}${kaligarLetter}${ornamentTypeLetter}${suffix}`;
}

[nameInput,maincategorySelect,subcategorySelect,kaligarSelect, ornamentTypeSelect].forEach(el => {
    el.addEventListener("change", generateCode);
});

// Prevent code regeneration during form submission
if (form) {
    form.addEventListener("submit", function(e) {
        isSubmitting = true;
    });
}

// On edit, if there is an ID but no stored code yet, generate immediately
if (objectPk && !codePreview.value) {
    generateCode();
}

});


</script>




{% endblock %}
